
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Detex Tutorial &#8212; detex __version__ = 1.0.9 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="detex-tutorial">
<h1>Detex Tutorial<a class="headerlink" href="#detex-tutorial" title="Permalink to this headline">¶</a></h1>
<p>Detex is a python package for performing waveform similarity clustering and subspace detection. It is written in python and relies heavily on Obspy, Numpy, Scipy, Matplotlib, and Pandas. If you are not familiar with python I recommend you install the <a class="reference external" href="http://continuum.io/downloads">anaconda distribution</a> for your platform and spend a few hours learning the basics of the language before attempting to use Detex. Here are some great tutorials:</p>
<p>http://www.stavros.io/tutorials/python/
http://www.tutorialspoint.com/python/python_quick_guide.htm</p>
<p>Also, any time spent learning <a class="reference external" href="http://docs.obspy.org/tutorial/">obspy</a> is a great investment as it is a very powerful tool for geophysical processing.</p>
<p>Some knowledge of pandas will also be useful, as the pandas DataFrame is used extensively in detex. <a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/10min.html">Here</a> is a 10 minute tutorial that will give you the basics.</p>
<p>Special thanks to Tex Kubacki (whose work inspired Detex), Jared Stein, and all the students and faculty at the University of Utah that helped test detex.</p>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>Detex can be installed by running the setup.py script in the distribution directory.</p>
</div>
<div class="section" id="workflow">
<h2>Workflow<a class="headerlink" href="#workflow" title="Permalink to this headline">¶</a></h2>
<p>The basic Detex workflow has five steps:</p>
<ol class="simple">
<li>Prepare required files</li>
<li>Data acquisition</li>
<li>Clustering</li>
<li>Subspace detection</li>
<li>Detection association</li>
</ol>
</div>
<div class="section" id="prepare-required-files">
<h2>1. Prepare required files<a class="headerlink" href="#prepare-required-files" title="Permalink to this headline">¶</a></h2>
<p>There are two required files: the station key and the template key.</p>
<p>The station key is generally saved as StationKey.csv. The following is an example:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">NEWTORK</th>
<th align="center">STATION</th>
<th align="center">STARTTIME</th>
<th align="center">ENDTIME</th>
<th align="center">LAT</th>
<th align="center">LON</th>
<th align="center">ELEVATION</th>
<th align="center">CHANNELS</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">TA</td>
<td align="center">M18A</td>
<td align="center">2009-04-01T00:00:00</td>
<td align="center">2009-04-04T00:00:00</td>
<td align="center">41.4272</td>
<td align="center">-110.0674</td>
<td align="center">2103</td>
<td align="center">BHE-BHN-BHZ</td>
</tr>
<tr>
<td align="center">TA</td>
<td align="center">M17A</td>
<td align="center">2009-04-01T00:00:00</td>
<td align="center">2009-04-04T00:00:00</td>
<td align="center">41.4729</td>
<td align="center">- 110.6664</td>
<td align="center">2101</td>
<td align="center">BHE-BHN-BHZ</td>
</tr>
</tbody>
</table><p>The STARTTIME and ENDTIME fields indicated the time range of the continuous data and can be in any format readable by the obspy.UTCDateTime class (including a time stamp). See the obspy.UTCDateTime docs for more info (http://docs.obspy.org/packages/autogen/obspy.core.utcdatetime.UTCDateTime.html)</p>
<p>The CHANNELS field should list the channels that will be used for each station separated by a dash (-). Additionally, any extra fields can be added without affecting Detex’s ability to read the file.</p>
<p>The template key by default is saved as TemplateKey.csv. It contains information on each of the events that will be used to scan the continuous data for previously undetected events. Here is a few lines of the template key included in this tutorial:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">CONTRIBUTOR</th>
<th align="center">NAME</th>
<th align="center">TIME</th>
<th align="center">LAT</th>
<th align="center">LON</th>
<th align="center">DEPTH</th>
<th align="center">MTYPE</th>
<th align="center">MAG</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">ANF</td>
<td align="center">2007-12-19T17-56-18</td>
<td align="center">2007-12-19T17-56-18</td>
<td align="center">41.7205</td>
<td align="center">-110.6486</td>
<td align="center">4.07</td>
<td align="center">ML</td>
<td align="center">2.36</td>
</tr>
<tr>
<td align="center">ANF</td>
<td align="center">2007-12-21T18-30-09</td>
<td align="center">2007-12-21T18-30-09</td>
<td align="center">41.7669</td>
<td align="center">-110.6122</td>
<td align="center">8.97</td>
<td align="center">ML</td>
<td align="center">2.17</td>
</tr>
<tr>
<td align="center">ANF</td>
<td align="center">2007-12-21T18-30-09</td>
<td align="center">2007-12-21T18-30-09</td>
<td align="center">41.7669</td>
<td align="center">-110.6122</td>
<td align="center">8.97</td>
<td align="center">ML</td>
<td align="center">2.17</td>
</tr>
</tbody>
</table><p>The CONTRIBUTOR, MTYPE, and DEPTH fields are not required but can be useful for record keeping. Additionally, any extra fields can be added in any order in order to better keep track of the events.</p>
<p>The NAME field can be any string that can also be used as a file name by your OS. Windows does not allow “:” in a file path so the “:” between the hour and minute, and between the minute and seconds, have been replaced with a “-“. Again, the time field can be in any format understood by obspy.UTCDateTime.</p>
<p>The LAT and LON fields are not strictly required for basic Detex functionality, but are used in some visualization methods.</p>
</div>
<div class="section" id="data-aquisition">
<h2>2. Data aquisition<a class="headerlink" href="#data-aquisition" title="Permalink to this headline">¶</a></h2>
<p>Detex can use a variety of data sources. In the intro tutorial we will use obspy’s <a class="reference external" href="https://docs.obspy.org/packages/autogen/obspy.station.inventory.Inventory.html">fdsn module</a> to download seismic data from IRIS and store it in a local directory structure for quick access.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">detex</span> <span class="c1">#import detex module</span>
<span class="c1"># the next line is only needed in ipython notebook to make sure all figures show inline </span>
<span class="o">%</span><span class="n">pylab</span> <span class="n">inline</span> 
<span class="n">detex</span><span class="o">.</span><span class="n">getdata</span><span class="o">.</span><span class="n">makeDataDirectories</span><span class="p">()</span> <span class="c1">#download all data from iris</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Populating</span> <span class="n">the</span> <span class="n">interactive</span> <span class="n">namespace</span> <span class="kn">from</span> <span class="nn">numpy</span> <span class="ow">and</span> <span class="n">matplotlib</span>
<span class="n">Getting</span> <span class="n">template</span> <span class="n">waveforms</span>
<span class="n">Getting</span> <span class="n">continuous</span> <span class="n">data</span>
<span class="n">finished</span> <span class="n">makeDataDirectories</span> <span class="n">call</span>
</pre></div>
</div>
</div>
<div class="section" id="clustering">
<h2>3. Clustering<a class="headerlink" href="#clustering" title="Permalink to this headline">¶</a></h2>
<p>The next step is to cross correlate every event with every other event in order to form waveform similarity groupings on each station. A single link-algorithm is used to perform the clustering up to a determined dissimilarity level.</p>
<p>In order to do this a clusterStream object is created, which is essentially a container for groupings on each station. The main input parameter is the required correlation coefficient, below which clustering will not occur. If you want to run each waveform as a 1D subspace (IE in waveform correlation detection) you can simply set the required correlation coefficient to 1. Conversely, if you want to include all events in the subspace regardless of similarity then set this parameter to 0. The default value is 0.5 can be easily changed without re-running the correlations. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">createCluster</span><span class="p">()</span> <span class="c1"># Create a clusters stream object</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">IO</span> <span class="n">operations</span> <span class="ow">and</span> <span class="n">data</span> <span class="n">checks</span>
<span class="n">data</span> <span class="kn">from</span> <span class="mi">2008</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">29</span><span class="n">T18</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mf">59.000000</span><span class="n">Z</span> <span class="n">to</span> <span class="mi">2008</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">29</span><span class="n">T18</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mf">09.000000</span><span class="n">Z</span> <span class="n">on</span> <span class="n">M18A</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">EventWaveForms</span>
<span class="n">performing</span> <span class="n">cluster</span> <span class="n">analysis</span> <span class="n">on</span> <span class="n">TA</span><span class="o">.</span><span class="n">M17A</span>
<span class="n">performing</span> <span class="n">cluster</span> <span class="n">analysis</span> <span class="n">on</span> <span class="n">TA</span><span class="o">.</span><span class="n">M18A</span>
<span class="n">CCreq</span> <span class="k">for</span> <span class="n">station</span> <span class="n">TA</span><span class="o">.</span><span class="n">M17A</span> <span class="n">updated</span> <span class="n">to</span> <span class="n">CCreq</span><span class="o">=</span><span class="mf">0.500</span>
<span class="n">CCreq</span> <span class="k">for</span> <span class="n">station</span> <span class="n">TA</span><span class="o">.</span><span class="n">M18A</span> <span class="n">updated</span> <span class="n">to</span> <span class="n">CCreq</span><span class="o">=</span><span class="mf">0.500</span>
<span class="n">writing</span> <span class="n">ClusterStream</span> <span class="n">instance</span> <span class="k">as</span> <span class="n">clust</span><span class="o">.</span><span class="n">pkl</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="o">.</span><span class="n">dendro</span><span class="p">()</span> <span class="c1">#create a dendrogram to visualize grouping structure on each station</span>
</pre></div>
</div>
<p><img alt="../../_images/output_7_1.png" src="../../_images/output_7_1.png" />png</p>
<p><img alt="../../_images/output_7_2.png" src="../../_images/output_7_2.png" />png</p>
<p>Now if we wanted to form strictly 4 groups on each station we can modify the required correlation coefficient for grouping. This can be done for all stations at once or for each station individually.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="o">.</span><span class="n">updateReqCC</span><span class="p">(</span><span class="o">.</span><span class="mi">55</span><span class="p">)</span>
<span class="n">cl</span><span class="o">.</span><span class="n">dendro</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CCreq</span> <span class="k">for</span> <span class="n">station</span> <span class="n">TA</span><span class="o">.</span><span class="n">M17A</span> <span class="n">updated</span> <span class="n">to</span> <span class="n">CCreq</span><span class="o">=</span><span class="mf">0.550</span>
<span class="n">CCreq</span> <span class="k">for</span> <span class="n">station</span> <span class="n">TA</span><span class="o">.</span><span class="n">M18A</span> <span class="n">updated</span> <span class="n">to</span> <span class="n">CCreq</span><span class="o">=</span><span class="mf">0.550</span>
</pre></div>
</div>
<p><img alt="../../_images/output_9_1.png" src="../../_images/output_9_1.png" />png</p>
<p><img alt="../../_images/output_9_2.png" src="../../_images/output_9_2.png" />png</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="p">[</span><span class="s1">&#39;TA.M17A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">updateReqCC</span><span class="p">(</span><span class="o">.</span><span class="mi">38</span><span class="p">)</span> <span class="c1"># set required correlation coef. for only station TA.M17A</span>
<span class="n">cl</span><span class="p">[</span><span class="s1">&#39;TA.M17A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dendro</span><span class="p">()</span> <span class="c1"># visualize grouping</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CCreq</span> <span class="k">for</span> <span class="n">station</span> <span class="n">TA</span><span class="o">.</span><span class="n">M17A</span> <span class="n">updated</span> <span class="n">to</span> <span class="n">CCreq</span><span class="o">=</span><span class="mf">0.380</span>
</pre></div>
</div>
<p><img alt="../../_images/output_10_1.png" src="../../_images/output_10_1.png" />png</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Similarity matricies can also be generated</span>
<span class="n">cl</span><span class="o">.</span><span class="n">simMatrix</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="../../_images/output_11_0.png" src="../../_images/output_11_0.png" />png</p>
<p><img alt="../../_images/output_11_1.png" src="../../_images/output_11_1.png" />png</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="o">.</span><span class="n">write</span><span class="p">()</span> <span class="c1"># save cluster object to disk</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">writing</span> <span class="n">ClusterStream</span> <span class="n">instance</span> <span class="k">as</span> <span class="n">clust</span><span class="o">.</span><span class="n">pkl</span>
</pre></div>
</div>
<p>There are several other functions of the ClusterStream class. Notably, input for hypoDD (a well-established double difference relocation program) can be created using the writeHypoDDEventInput, writeHypoDDStationInput, and writeSimpleHypoDDInput class methods; although as of version 0.1.0 they have not been fully tested. I hope to develop other methods for locating detected events in the future.</p>
</div>
<div class="section" id="subspace-detection">
<h2>4. Subspace detection<a class="headerlink" href="#subspace-detection" title="Permalink to this headline">¶</a></h2>
<p>The subspace creation process is applied to each waveform similarity group. The process involves 1) aligning the waveforms to optimize similarity, 2) performing a singular value decomposition, 3) determining a required dimension of representation, and 4) setting a significant detection statistic threshold. As a final step 5) the subspace detectors are run on each station and saved to an SQLite database.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># First, the creation of the SubSpaceStream</span>
<span class="n">ss</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">createSubSpace</span><span class="p">()</span> 
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="kn">from</span> <span class="mi">2008</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">29</span><span class="n">T18</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mf">59.000000</span><span class="n">Z</span> <span class="n">to</span> <span class="mi">2008</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">29</span><span class="n">T18</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mf">09.000000</span><span class="n">Z</span> <span class="n">on</span> <span class="n">M18A</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">EventWaveForms</span>
<span class="n">Starting</span> <span class="n">Subspace</span> <span class="n">Construction</span>
</pre></div>
</div>
<div class="section" id="trim-waveforms">
<h3>4.1 Trim waveforms<a class="headerlink" href="#trim-waveforms" title="Permalink to this headline">¶</a></h3>
<p>The next step is to set the beginning trim time for each subspace group and un-clustered singleton on each station. This can be done by calling GUI based pick functions built into the SubSpaceStream class (here it would be ss.detex.pickTimes()),or by attaching a csv or pickled pandas data frame with the following populated fields populated for at least one phase of each event-station pair:
TimeStamp, Station, Event, Phase.</p>
<p>The EventPicks.pkl file included in the tutorial is such a file (you can create this file by calling detex.util.pickPhases or load the dataframe by calling pandas.read_csv).</p>
<p>Detex will then find the first arriving phase for each waveform (event-station pair) and average for the entire aligned group. From the average first arrival sample the waveforms will be trimmed to some duration ( 30 seconds default) or to the last arriving phase. See the function docs for further details.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ss</span><span class="o">.</span><span class="n">attachPickTimes</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="perform-svd-set-dimension-of-representation-and-set-threshold">
<h3>4.2, 4.3, 4.4 Perform SVD, set dimension of representation, and set threshold<a class="headerlink" href="#perform-svd-set-dimension-of-representation-and-set-threshold" title="Permalink to this headline">¶</a></h3>
<p>Next a singular value decomposition is performed on the  waveform groups that have been aligned and trimmed. A dimension of representation (IE the number of left singular vectors used to describe the waveform family) is calculated based on the fractional energy capture of 90% (by default). A detection statistic (DS) threshold for each subspace and singleton is then determined by calculated the detection statistic of the subspace with random continuous data that contains no high amplitude signals, fitting a beta PDF to the distribution, and finding the DS corresponding to the selected probability of false detection $10^{-12}$ by default).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ss</span><span class="o">.</span><span class="n">SVD</span><span class="p">()</span>
</pre></div>
</div>
<p>###4.5 Run detectors
Detex will scan the continuous data for each station-subspace pair and declare a detection whenever any subspace’s threshold is exceeded.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ss</span><span class="o">.</span><span class="n">detex</span><span class="p">(</span><span class="n">useSingles</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># run subspace detections and also run unclustered events as 1D subspaces </span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Deleting</span> <span class="n">old</span> <span class="n">subspace</span> <span class="n">database</span> <span class="n">SubSpace</span><span class="o">.</span><span class="n">db</span>
<span class="n">Subspaces</span> <span class="n">on</span> <span class="n">TA</span><span class="o">.</span><span class="n">M17A</span> <span class="n">completed</span><span class="p">,</span> <span class="mi">7</span> <span class="n">potential</span> <span class="n">detection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">recorded</span>
<span class="n">Subspaces</span> <span class="n">on</span> <span class="n">TA</span><span class="o">.</span><span class="n">M18A</span> <span class="n">completed</span><span class="p">,</span> <span class="mi">40</span> <span class="n">potential</span> <span class="n">detection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">recorded</span>
<span class="n">Singletons</span> <span class="n">on</span> <span class="n">TA</span><span class="o">.</span><span class="n">M17A</span> <span class="n">completed</span><span class="p">,</span> <span class="mi">6</span> <span class="n">potential</span> <span class="n">detection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">recorded</span>
<span class="n">Singletons</span> <span class="n">on</span> <span class="n">TA</span><span class="o">.</span><span class="n">M18A</span> <span class="n">completed</span><span class="p">,</span> <span class="mi">11</span> <span class="n">potential</span> <span class="n">detection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">recorded</span>
</pre></div>
</div>
<p>The results are saved to an sqlite database. The following tables are saved in the database (named SubSpace.db by default):</p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Table</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">ss_df</td>
<td align="center">Results of the detections for the subspaces</td>
</tr>
<tr>
<td align="center">sg_df</td>
<td align="center">Detection results for the singletons (un-clustered events)</td>
</tr>
<tr>
<td align="center">filt_params</td>
<td align="center">Filter parameters used for the detections</td>
</tr>
<tr>
<td align="center">ss_info</td>
<td align="center">General information about each of the subspaces (such as station, comprising events, thresholds, etc.)</td>
</tr>
<tr>
<td align="center">sg_info</td>
<td align="center">General information about each singleton</td>
</tr>
<tr>
<td align="center">ss_hist</td>
<td align="center">Binned counts of all detection statistic values for subspaces</td>
</tr>
<tr>
<td align="center">sg_hist</td>
<td align="center">Binned counts of all detection statistic values for singletons</td>
</tr>
</tbody>
</table><p>Any of these tables can be loaded into a dataframe using the detex.util.loadSQLite function. For example, if we wanted to make an ugly plot of all of the detection statistic values for the subspaces:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span> <span class="c1">#import matplotlib for visualization</span>
<span class="kn">import</span> <span class="nn">json</span> <span class="c1"># used to convert string arrays as loaded from sql to numpy arrays</span>

<span class="c1"># load the ss_hist table of the SubSpace.db sqlite database</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">loadSQLite</span><span class="p">(</span><span class="s1">&#39;SubSpace.db&#39;</span><span class="p">,</span><span class="s1">&#39;ss_hist&#39;</span><span class="p">)</span> 

<span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">hist</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span> <span class="c1">#loop over datarame</span>
    <span class="c1">#convert string arrays into numpy arrays </span>
    <span class="n">hist</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Value</span><span class="p">))</span> 

<span class="c1"># middle of bin values for histograms</span>
<span class="n">avbins</span><span class="o">=</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Value</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">hist</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Value</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.0</span> 

<span class="c1">## Plot each histogram</span>
<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">hist</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span> <span class="c1"># loop again through dataframe</span>
    <span class="k">if</span> <span class="n">ind</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># skip if index of dataframe is 0 (these are the bin values)</span>
        <span class="k">continue</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">avbins</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">Sta</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="c1">#plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Detection Statistic&#39;</span><span class="p">)</span> <span class="c1">#label x</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Occurrence Rate&#39;</span><span class="p">)</span> <span class="c1"># label y</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Binned Detection Statistics&#39;</span><span class="p">)</span> <span class="c1"># lable title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span> <span class="c1">#add legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span> <span class="c1">#use semilog on y axis</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">])</span> <span class="c1">#set x lim</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1">#show plot</span>
    
</pre></div>
</div>
<p><img alt="tutorial/Intro/Images/output_23_0.png" src="tutorial/Intro/Images/output_23_0.png" />png</p>
</div>
</div>
<div class="section" id="associate-detections">
<h2>5 Associate detections<a class="headerlink" href="#associate-detections" title="Permalink to this headline">¶</a></h2>
<p>The detex module “results” is used to associate all of the detections (DS that exceeded the determined threshold) on various stations together into coherent events. The association requirement is an overlap in predicted origin times. If a verification data set (IE event ground-truth) is available it can be used to assess detector performance.</p>
<p>Note: If possible, it is very important to use at least 2 stations separated in space in order to reduce false detections.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># associate events together, only require events to occur on 2 stations (that&#39;s all we have), count detections verified if they</span>
<span class="c1"># occure within 10 minutes (5 minutes on either side) of reported origin times in blasting catalog. </span>
<span class="nb">reload</span><span class="p">(</span><span class="n">detex</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">detResults</span><span class="p">(</span><span class="n">requiredNumStations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">veriBuffer</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">veriFile</span><span class="o">=</span><span class="s1">&#39;veriFile.csv&#39;</span><span class="p">)</span> 
</pre></div>
</div>
<p>The associations may take a while for large data sets, there are still some optimizations that need to be implemented.
The verified detections, new detections, and auto detections (detection of training events) are stored in the form of pandas DataFrames that can be accessed by the Vers, Dets, and Autos attributes of the DetResults object. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">Dets</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Event</th>
      <th>DSav</th>
      <th>DSmax</th>
      <th>NumStations</th>
      <th>DS_STALTA</th>
      <th>MSTAMPmin</th>
      <th>MSTAMPmax</th>
      <th>Mag</th>
      <th>ProEnMag</th>
      <th>Verified</th>
      <th>Dets</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2009-04-01T20-25-45</td>
      <td>0.632428</td>
      <td>0.777134</td>
      <td>2</td>
      <td>2.865539</td>
      <td>1.238618e+09</td>
      <td>1.238618e+09</td>
      <td>2.228544</td>
      <td>2.123271</td>
      <td>True</td>
      <td>DS  DS_STALTA          STMP Name    ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2009-04-02T16-27-05</td>
      <td>0.683522</td>
      <td>0.775374</td>
      <td>2</td>
      <td>3.094301</td>
      <td>1.238690e+09</td>
      <td>1.238690e+09</td>
      <td>2.167367</td>
      <td>2.082825</td>
      <td>True</td>
      <td>DS  DS_STALTA          STMP Name    ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2009-04-02T19-16-52</td>
      <td>0.462497</td>
      <td>0.571445</td>
      <td>2</td>
      <td>4.166801</td>
      <td>1.238700e+09</td>
      <td>1.238700e+09</td>
      <td>1.911200</td>
      <td>1.737617</td>
      <td>True</td>
      <td>DS  DS_STALTA          STMP Name    ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2009-04-03T17-34-28</td>
      <td>0.356600</td>
      <td>0.468542</td>
      <td>2</td>
      <td>3.975309</td>
      <td>1.238780e+09</td>
      <td>1.238780e+09</td>
      <td>1.707991</td>
      <td>1.472878</td>
      <td>True</td>
      <td>DS  DS_STALTA          STMP Name    ...</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">Autos</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Event</th>
      <th>DSav</th>
      <th>DSmax</th>
      <th>NumStations</th>
      <th>DS_STALTA</th>
      <th>MSTAMPmin</th>
      <th>MSTAMPmax</th>
      <th>Mag</th>
      <th>ProEnMag</th>
      <th>Verified</th>
      <th>Dets</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2009-04-01T17-36-58</td>
      <td>0.852087</td>
      <td>0.999722</td>
      <td>2</td>
      <td>7.428352</td>
      <td>1.238607e+09</td>
      <td>1.238607e+09</td>
      <td>2.425216</td>
      <td>2.387209</td>
      <td>True</td>
      <td>DS  DS_STALTA          STMP Name     ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2009-04-03T15-39-27</td>
      <td>0.825582</td>
      <td>0.896323</td>
      <td>2</td>
      <td>3.782953</td>
      <td>1.238773e+09</td>
      <td>1.238773e+09</td>
      <td>2.281703</td>
      <td>2.239343</td>
      <td>True</td>
      <td>DS  DS_STALTA          STMP Name    ...</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">Vers</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Event</th>
      <th>DSav</th>
      <th>DSmax</th>
      <th>NumStations</th>
      <th>DS_STALTA</th>
      <th>MSTAMPmin</th>
      <th>MSTAMPmax</th>
      <th>Mag</th>
      <th>ProEnMag</th>
      <th>Dets</th>
      <th>STMP</th>
      <th>MWD</th>
      <th>VerMag</th>
      <th>VerLat</th>
      <th>VerLon</th>
      <th>VerDepth</th>
      <th>VerName</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2009-04-01T17-36-58</td>
      <td>0.852087</td>
      <td>0.999722</td>
      <td>2</td>
      <td>7.428352</td>
      <td>1.238607e+09</td>
      <td>1.238607e+09</td>
      <td>2.425216</td>
      <td>2.387209</td>
      <td>DS  DS_STALTA          STMP Name     ...</td>
      <td>1238607300</td>
      <td>2943</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>9107</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2009-04-01T20-25-45</td>
      <td>0.632428</td>
      <td>0.777134</td>
      <td>2</td>
      <td>2.865539</td>
      <td>1.238618e+09</td>
      <td>1.238618e+09</td>
      <td>2.228544</td>
      <td>2.123271</td>
      <td>DS  DS_STALTA          STMP Name    ...</td>
      <td>1238617320</td>
      <td>1713</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>9108</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2009-04-02T16-27-05</td>
      <td>0.683522</td>
      <td>0.775374</td>
      <td>2</td>
      <td>3.094301</td>
      <td>1.238690e+09</td>
      <td>1.238690e+09</td>
      <td>2.167367</td>
      <td>2.082825</td>
      <td>DS  DS_STALTA          STMP Name    ...</td>
      <td>1238689440</td>
      <td>1542</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>9109</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2009-04-02T19-16-52</td>
      <td>0.462497</td>
      <td>0.571445</td>
      <td>2</td>
      <td>4.166801</td>
      <td>1.238700e+09</td>
      <td>1.238700e+09</td>
      <td>1.911200</td>
      <td>1.737617</td>
      <td>DS  DS_STALTA          STMP Name    ...</td>
      <td>1238700000</td>
      <td>812</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>9110</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2009-04-03T15-39-27</td>
      <td>0.825582</td>
      <td>0.896323</td>
      <td>2</td>
      <td>3.782953</td>
      <td>1.238773e+09</td>
      <td>1.238773e+09</td>
      <td>2.281703</td>
      <td>2.239343</td>
      <td>DS  DS_STALTA          STMP Name    ...</td>
      <td>1238772960</td>
      <td>2233</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>9111</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2009-04-03T17-34-28</td>
      <td>0.356600</td>
      <td>0.468542</td>
      <td>2</td>
      <td>3.975309</td>
      <td>1.238780e+09</td>
      <td>1.238780e+09</td>
      <td>1.707991</td>
      <td>1.472878</td>
      <td>DS  DS_STALTA          STMP Name    ...</td>
      <td>1238779800</td>
      <td>1022</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>9112</td>
    </tr>
  </tbody>
</table>
</div><p>Loading the mine’s blast log we can see that all six blasts over the four days were successfully detected with no false detections. Note: the magnitude, latitude, longitude, and depth were not known so I simply use dummy values here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;veriFile.csv&#39;</span><span class="p">)</span>
<span class="n">log</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>TIME</th>
      <th>MAG</th>
      <th>LAT</th>
      <th>LON</th>
      <th>DEPTH</th>
      <th>MWD</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>9107</td>
      <td>2009-04-01T17-35-00</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>2943</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9108</td>
      <td>2009-04-01T20-22-00</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>1713</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9109</td>
      <td>2009-04-02T16-24-00</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>1542</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9110</td>
      <td>2009-04-02T19-20-00</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>812</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9111</td>
      <td>2009-04-03T15-36-00</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>2233</td>
    </tr>
    <tr>
      <th>5</th>
      <td>9112</td>
      <td>2009-04-03T17-30-00</td>
      <td>2</td>
      <td>n/a</td>
      <td>n/a</td>
      <td>0</td>
      <td>1022</td>
    </tr>
  </tbody>
</table>
</div><p>If we only required the detections to occur on one station, however, (even with the default ultra-conservative acceptable probability of false detection of $10^{-12}$ the detector will return many false detections. For this reason it is important to use more than one station when possible.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">detex</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">detResults</span><span class="p">(</span><span class="n">requiredNumStations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">veriBuffer</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">veriFile</span><span class="o">=</span><span class="s1">&#39;veriFile.csv&#39;</span><span class="p">)</span>
<span class="n">res</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SSResults</span> <span class="n">instance</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">autodections</span> <span class="ow">and</span> <span class="mi">23</span> <span class="n">new</span> <span class="n">detections</span><span class="p">,</span> <span class="mi">6</span> <span class="n">are</span> <span class="n">verified</span>
</pre></div>
</div>
<p>Once we have detected new events we can instruct detex to extract the waveforms of the new detections. With the extracted waveforms phase picks can be made in order to located the newly-found events, cross correlation lag times can be calculated with the clustering and the detected events can be used to create a new detector to potentially find more events.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">writeDetections</span><span class="p">(</span><span class="n">eventDir</span><span class="o">=</span><span class="s1">&#39;DetectedEvents&#39;</span><span class="p">,</span><span class="n">updateTemKey</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Now the waveforms of the newly detected events have been stored with the same directory structure as the TemplateWaveForms directory in a directory named DetectedEvents (because this is the argument we assigned to it). A new template key of the detected events can also be created, or by default the current template key csv will be updated with the newly detected events. The naming convention is the same but detected events will have a lowercase “d,” for detected, at the start of the name string. The entire process can then be repeated to try and detect even more events, but in this case we know we have found all that there is to find.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">detex</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../detex.html">detex package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Derrick Chambers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/tutorial/Intro/intro.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>