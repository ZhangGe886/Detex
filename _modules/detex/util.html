
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>detex.util &#8212; detex __version__ = 1.0.9 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for detex.util</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu May 29 16:41:48 2014</span>

<span class="sd">@author: Derrick</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># python 2 and 3 compatibility imports</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">with_statement</span><span class="p">,</span> <span class="n">nested_scopes</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sqlite3</span> <span class="k">import</span> <span class="n">PARSE_DECLTYPES</span><span class="p">,</span> <span class="n">connect</span>

<span class="kn">import</span> <span class="nn">PyQt4</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">obspy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pandas.io.sql</span> <span class="k">as</span> <span class="nn">psql</span>
<span class="kn">import</span> <span class="nn">simplekml</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">string_types</span>

<span class="kn">import</span> <span class="nn">detex</span>
<span class="kn">import</span> <span class="nn">detex.pandas_dbms</span>


<span class="c1">######################### KML functions ###############################</span>

<div class="viewcode-block" id="writeKMLFromDF"><a class="viewcode-back" href="../../detex.html#detex.util.writeKMLFromDF">[docs]</a><span class="k">def</span> <span class="nf">writeKMLFromDF</span><span class="p">(</span><span class="n">DF</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;map.kml&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a KML file from a pandas data frame with the same format as</span>
<span class="sd">    readSum output</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kml</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Kml</span><span class="p">(</span><span class="nb">open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">DF</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">pnt</span> <span class="o">=</span> <span class="n">kml</span><span class="o">.</span><span class="n">newpoint</span><span class="p">()</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">DateString</span><span class="p">)</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Lon</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Lat</span><span class="p">)]</span>
    <span class="n">kml</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeKMLFromTemplateKey"><a class="viewcode-back" href="../../detex.html#detex.util.writeKMLFromTemplateKey">[docs]</a><span class="k">def</span> <span class="nf">writeKMLFromTemplateKey</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="s1">&#39;TemplateKey.csv&#39;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;templates.kml&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a KML file from a templateKey</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    DF : str or pandas Dataframe</span>
<span class="sd">        If str then the path to the template key csv. If dataframe then</span>
<span class="sd">        template key loaded with readKey function with key_type=&#39;template&#39;</span>
<span class="sd">    outname : str</span>
<span class="sd">        path of the kml file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Input type not understood, must be path to template key or &#39;</span>
               <span class="s1">&#39;dataframe of templatekey&#39;</span><span class="p">)</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

    <span class="n">kml</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Kml</span><span class="p">(</span><span class="nb">open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">pnt</span> <span class="o">=</span> <span class="n">kml</span><span class="o">.</span><span class="n">newpoint</span><span class="p">()</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LON</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LAT</span><span class="p">)]</span>
    <span class="n">kml</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeKMLFromStationKey"><a class="viewcode-back" href="../../detex.html#detex.util.writeKMLFromStationKey">[docs]</a><span class="k">def</span> <span class="nf">writeKMLFromStationKey</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="s1">&#39;StationKey.csv&#39;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;stations.kml&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a KML file from a station key</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    DF : str or pandas Dataframe</span>
<span class="sd">        If str then the path to the station key. If dataframe then</span>
<span class="sd">        station key loaded with readKey function with key_type=&#39;template&#39;</span>
<span class="sd">    outname : str</span>
<span class="sd">        name of the kml file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Input type not understood, must be path to station key or &#39;</span>
               <span class="s1">&#39;dataframe of station key&#39;</span><span class="p">)</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">kml</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Kml</span><span class="p">(</span><span class="nb">open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">pnt</span> <span class="o">=</span> <span class="n">kml</span><span class="o">.</span><span class="n">newpoint</span><span class="p">()</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">STATION</span><span class="p">)</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LON</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LAT</span><span class="p">)]</span>
        <span class="c1"># print(a[1].STATION,a[1].LON,a[1].LAT)</span>
    <span class="n">kml</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeKMLFromHypInv"><a class="viewcode-back" href="../../detex.html#detex.util.writeKMLFromHypInv">[docs]</a><span class="k">def</span> <span class="nf">writeKMLFromHypInv</span><span class="p">(</span><span class="n">hypout</span><span class="o">=</span><span class="s1">&#39;sum2000&#39;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;hypoInv.kml&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses simplekml to create a KML file (used by Google Earth, Google Maps,</span>
<span class="sd">    etc) of the results from hypoInverse 2000</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">C</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hypout</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">openfile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">openfile</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span> <span class="o">+</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">31</span><span class="p">]]</span>
    <span class="n">kml</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Kml</span><span class="p">(</span><span class="nb">open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">C</span><span class="p">:</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spl</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">spl</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">21</span><span class="p">])</span> <span class="o">/</span>
                                   <span class="mi">60</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">spl</span><span class="p">[</span><span class="mi">21</span><span class="p">:</span><span class="mi">23</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
        <span class="c1"># assume negative sign needs to be added for west</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">spl</span><span class="p">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span> <span class="o">+</span> <span class="o">-</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">spl</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">29</span><span class="p">])</span> <span class="o">/</span>
                                     <span class="mf">60.0</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">spl</span><span class="p">[</span><span class="mi">29</span><span class="p">:</span><span class="mi">31</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
        <span class="n">pnt</span> <span class="o">=</span> <span class="n">kml</span><span class="o">.</span><span class="n">newpoint</span><span class="p">()</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]))</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)]</span>
    <span class="n">kml</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeKMLFromArcDF"><a class="viewcode-back" href="../../detex.html#detex.util.writeKMLFromArcDF">[docs]</a><span class="k">def</span> <span class="nf">writeKMLFromArcDF</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;Arc.kml&#39;</span><span class="p">):</span>
    <span class="n">kml</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Kml</span><span class="p">(</span><span class="nb">open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">pnt</span> <span class="o">=</span> <span class="n">kml</span><span class="o">.</span><span class="n">newpoint</span><span class="p">()</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;verlon&#39;</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;verlat&#39;</span><span class="p">])]</span>
    <span class="n">kml</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeKMLfromHYPInput"><a class="viewcode-back" href="../../detex.html#detex.util.writeKMLfromHYPInput">[docs]</a><span class="k">def</span> <span class="nf">writeKMLfromHYPInput</span><span class="p">(</span><span class="n">hypin</span><span class="o">=</span><span class="s1">&#39;test.pha&#39;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;hypoInInv.kml&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hypin</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
        <span class="n">kml</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Kml</span><span class="p">(</span><span class="nb">open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cou</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;      &#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;      &#39;</span><span class="p">:</span>
                <span class="c1"># print &#39;terminator line&#39;</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">19</span><span class="p">])</span> <span class="o">/</span> \
                                            <span class="mi">60</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">21</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span> <span class="o">+</span> <span class="o">-</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">25</span><span class="p">:</span><span class="mi">27</span><span class="p">])</span> <span class="o">/</span> \
                                              <span class="mf">60.0</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">29</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
                <span class="n">pnt</span> <span class="o">=</span> <span class="n">kml</span><span class="o">.</span><span class="n">newpoint</span><span class="p">()</span>
                <span class="n">pnt</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cou</span><span class="p">)</span>
                <span class="n">pnt</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)]</span>
                <span class="n">cou</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">kml</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeKMLFromHypDD"><a class="viewcode-back" href="../../detex.html#detex.util.writeKMLFromHypDD">[docs]</a><span class="k">def</span> <span class="nf">writeKMLFromHypDD</span><span class="p">(</span><span class="n">hypreloc</span><span class="o">=</span><span class="s1">&#39;hypoDD.reloc&#39;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;hypo.kml&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses simplekml to create a KML file (used by Google Earth,</span>
<span class="sd">    Google Maps, etc) of the results from hypoDD</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">hypreloc</span><span class="p">))</span>
    <span class="n">kml</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Kml</span><span class="p">(</span><span class="nb">open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="n">pnt</span> <span class="o">=</span> <span class="n">kml</span><span class="o">.</span><span class="n">newpoint</span><span class="p">()</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="n">kml</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeKMLFromEQSearchSum"><a class="viewcode-back" href="../../detex.html#detex.util.writeKMLFromEQSearchSum">[docs]</a><span class="k">def</span> <span class="nf">writeKMLFromEQSearchSum</span><span class="p">(</span><span class="n">eqsum</span><span class="o">=</span><span class="s1">&#39;eqsrchsum&#39;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;eqsearch.kml&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a KML from the eqsearch sum file (produced by the University</span>
<span class="sd">    of Utah seismograph stations code EQsearch)</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    eqsum : str</span>
<span class="sd">        eqsearch sum. file</span>
<span class="sd">    outname : str</span>
<span class="sd">        name of the kml file</span>
<span class="sd">    Notes</span>
<span class="sd">    -------------</span>
<span class="sd">    Code assimes any year code above 50 belongs to 1900, and any year code</span>
<span class="sd">    less than 50 belongs to 2000 (since eqsrchsum is not y2k compliant)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clspecs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span>
               <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span> <span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">36</span><span class="p">),</span> <span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="mi">43</span><span class="p">),</span> <span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="mi">50</span><span class="p">)]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;mo&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;latdeg&#39;</span><span class="p">,</span> <span class="s1">&#39;latmin&#39;</span><span class="p">,</span>
             <span class="s1">&#39;londeg&#39;</span><span class="p">,</span> <span class="s1">&#39;lonmin&#39;</span><span class="p">,</span> <span class="s1">&#39;dep&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_fwf</span><span class="p">(</span><span class="n">eqsum</span><span class="p">,</span> <span class="n">colspecs</span><span class="o">=</span><span class="n">clspecs</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;19</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;20</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]]</span>
    <span class="n">month</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mo&#39;</span><span class="p">]]</span>
    <span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]]</span>
    <span class="n">hr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hr&#39;</span><span class="p">]]</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]]</span>
    <span class="n">second</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%05.02f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">]]</span>
    <span class="n">TIME</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">T</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="n">x6</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="n">x6</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hr</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)]</span>
    <span class="n">Lat</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;latdeg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;latmin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="mf">60.0</span>
    <span class="n">Lon</span> <span class="o">=</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;londeg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lonmin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="mf">60.0</span>

    <span class="n">kml</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Kml</span><span class="p">(</span><span class="nb">open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">T</span><span class="p">,</span> <span class="n">Lat</span><span class="p">,</span> <span class="n">Lon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">TIME</span><span class="p">,</span> <span class="n">Lat</span><span class="p">,</span> <span class="n">Lon</span><span class="p">):</span>
        <span class="n">pnt</span> <span class="o">=</span> <span class="n">kml</span><span class="o">.</span><span class="n">newpoint</span><span class="p">()</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">pnt</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Lon</span><span class="p">,</span> <span class="n">Lat</span><span class="p">)]</span>
    <span class="n">kml</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<span class="c1">############## HypoDD Functions ################</span>

<div class="viewcode-block" id="writeHypoDDStationInput"><a class="viewcode-back" href="../../detex.html#detex.util.writeHypoDDStationInput">[docs]</a><span class="k">def</span> <span class="nf">writeHypoDDStationInput</span><span class="p">(</span><span class="n">stakey</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="s1">&#39;station.dat&#39;</span><span class="p">,</span> <span class="n">useElevations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">inFt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write the station input file for hypoDD (station.dat)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    stakey : str or DataFrame</span>
<span class="sd">        Path to station key or instance of DataFrame with station key loaded</span>
<span class="sd">    fileName : str</span>
<span class="sd">        Path to the output file</span>
<span class="sd">    useElevations : boolean</span>
<span class="sd">        If true also print elevations</span>
<span class="sd">    inFt : boolean</span>
<span class="sd">        If true elevations in station key are in ft, convert to meters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stakey</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">stakey</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">stakey</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;station&#39;</span><span class="p">)</span>
    <span class="n">fil</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">conFact</span> <span class="o">=</span> <span class="mf">0.3048</span> <span class="k">if</span> <span class="n">inFt</span> <span class="k">else</span> <span class="mi">1</span>  <span class="c1"># ft to meters if needed</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">stakey</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">row</span><span class="o">.</span><span class="n">NETWORK</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">STATION</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">LAT</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">LON</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">useElevations</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">row</span><span class="o">.</span><span class="n">ELEVATION</span> <span class="o">*</span> <span class="n">conFact</span>
        <span class="n">fil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fil</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="writeHypoDDEventInput"><a class="viewcode-back" href="../../detex.html#detex.util.writeHypoDDEventInput">[docs]</a><span class="k">def</span> <span class="nf">writeHypoDDEventInput</span><span class="p">(</span><span class="n">temkey</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="s1">&#39;event.dat&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a hypoDD event file (event.dat)</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    temkey : str or pandas DataFrame</span>
<span class="sd">        If str then path to template key, else loaded template key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temkey</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">temkey</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">temkey</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
    <span class="n">fil</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">reqZeros</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temkey</span><span class="p">))))</span>
    <span class="n">fomatstr</span> <span class="o">=</span> <span class="s1">&#39;{:0&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reqZeros</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;d}&#39;</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">temkey</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">utc</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">TIME</span><span class="p">)</span>
        <span class="n">DATE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%04d%02d%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">utc</span><span class="o">.</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">utc</span><span class="o">.</span><span class="n">month</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">utc</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>
        <span class="n">TIME</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02d%02d%04d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">utc</span><span class="o">.</span><span class="n">hour</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">utc</span><span class="o">.</span><span class="n">minute</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">utc</span><span class="o">.</span><span class="n">second</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">MAG</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">MAG</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">20</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">ID</span> <span class="o">=</span> <span class="n">fomatstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="n">linea</span> <span class="o">=</span> <span class="p">(</span><span class="n">DATE</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">TIME</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:04f}</span><span class="s1">, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">LAT</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39;</span><span class="si">{:04f}</span><span class="s1">, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">LON</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:02f}</span><span class="s1">, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">DEPTH</span><span class="p">))</span>
        <span class="n">lineb</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:02f}</span><span class="s1">, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;0.0, 0.0, 0.0, &#39;</span> <span class="o">+</span> <span class="n">ID</span>
        <span class="n">fil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">linea</span> <span class="o">+</span> <span class="n">lineb</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fil</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1">############## Hypoinverse Functions ################</span>
<div class="viewcode-block" id="makeHypoInversePhaseFile"><a class="viewcode-back" href="../../detex.html#detex.util.makeHypoInversePhaseFile">[docs]</a><span class="k">def</span> <span class="nf">makeHypoInversePhaseFile</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="n">evekey</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">usePhases</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">],</span>
                             <span class="n">fixFirstStation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a hypoinverse phase file used by hypoinverse, format defined</span>
<span class="sd">    on page 113 of the manual for version 1.39, using the phase file created</span>
<span class="sd">    by detex.util.pickPhases. Format for this file is free csv with the</span>
<span class="sd">    following fields: TimeStamp (epoch time in seconds), Station (net.sta),</span>
<span class="sd">    Event (unique event id, usually datestring, must be the same in</span>
<span class="sd">    templatekey), Phase (phase identifier, generally only P or S)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    phases : pandas dataframe or path to csv</span>
<span class="sd">        Phase input from AssociatePhases script</span>
<span class="sd">    evekey : pandas dataframe or csv</span>
<span class="sd">        Event info</span>
<span class="sd">    outname : str</span>
<span class="sd">        File name (path) to write</span>
<span class="sd">    fix : int</span>
<span class="sd">        if fix==0 nothing is fixed, fix==1 depths are fixed, fix==2</span>
<span class="sd">        hypocenters fixed, fix==3 hypocenters and origin time fixed</span>
<span class="sd">    usePhases : list</span>
<span class="sd">        List of phases to use, all other phases will be skipped</span>
<span class="sd">    fixFirstStation : bool</span>
<span class="sd">        If True do not set any lat, lon, or depth on each terminator</span>
<span class="sd">        line. HypoInverse will then use the first hit station as the</span>
<span class="sd">        starting location with some reasonable depth (a few kilometers)</span>

<span class="sd">    Note</span>
<span class="sd">    --------</span>
<span class="sd">    Assumes the channel to be ZENZ for writing file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">phases</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;phases&#39;</span><span class="p">)</span>
    <span class="n">evekey</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">evekey</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">phafil</span><span class="p">:</span>
        <span class="n">phafil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">eveind</span><span class="p">,</span> <span class="n">everow</span> <span class="ow">in</span> <span class="n">evekey</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  <span class="c1"># Loop events</span>
            <span class="n">phas</span> <span class="o">=</span> <span class="n">phases</span><span class="p">[</span><span class="n">phases</span><span class="o">.</span><span class="n">Event</span> <span class="o">==</span> <span class="n">everow</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phas</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># go to next event if no phase info</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">phaind</span><span class="p">,</span> <span class="n">pha</span> <span class="ow">in</span> <span class="n">phas</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">stmp</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">pha</span><span class="o">.</span><span class="n">TimeStamp</span><span class="p">)</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="n">pha</span><span class="o">.</span><span class="n">Phase</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">net</span> <span class="o">=</span> <span class="n">pha</span><span class="o">.</span><span class="n">Station</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sta</span> <span class="o">=</span> <span class="n">pha</span><span class="o">.</span><span class="n">Station</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="n">pha</span><span class="o">.</span><span class="n">Channel</span>
                <span class="c1"># make sure all chans/stations have expected lengths</span>
                <span class="n">_checkLens</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">sta</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">phase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usePhases</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">_makeSHypStationLine</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">stmp</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
                <span class="n">phafil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">_makeHypTermLine</span><span class="p">(</span><span class="n">pha</span><span class="p">,</span> <span class="n">everow</span><span class="p">,</span> <span class="n">fix</span><span class="p">,</span> <span class="n">fixFirstStation</span><span class="p">)</span>
            <span class="n">phafil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
            <span class="n">phafil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_checkLens</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">sta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check max lens of net (2), chan(3), and sta (5)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;network code must be 2 characters or less, </span><span class="si">%s</span><span class="s1"> is not&#39;</span> <span class="o">%</span> <span class="n">net</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;channel code must be 3 characters or less, </span><span class="si">%s</span><span class="s1"> is not&#39;</span> <span class="o">%</span> <span class="n">chan</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;station code must be 5 characters or less, </span><span class="si">%s</span><span class="s1"> is not&#39;</span> <span class="o">%</span> <span class="n">sta</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_makeSHypStationLine</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">cha</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pha</span><span class="p">):</span>
    <span class="n">Ptime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    <span class="n">datestring</span> <span class="o">=</span> <span class="n">_killChars</span><span class="p">(</span><span class="n">Ptime</span><span class="o">.</span><span class="n">format_iris_web_service</span><span class="p">())</span>
    <span class="n">YYYYMMDDHHMM</span> <span class="o">=</span> <span class="n">datestring</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">datestring</span><span class="p">[</span><span class="mi">12</span><span class="p">:])</span>
    <span class="n">ssss</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%5.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">secs</span>
    <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> 0&#39;</span> <span class="o">%</span> <span class="n">pha</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&lt;5}{:&lt;4}{:&lt;5}{:&lt;3}{:&lt;12}{:&lt;80}{:&lt;2}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">sta</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">cha</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">YYYYMMDDHHMM</span><span class="p">,</span> <span class="n">ssss</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="k">def</span> <span class="nf">_makeHypTermLine</span><span class="p">(</span><span class="n">pha</span><span class="p">,</span> <span class="n">everow</span><span class="p">,</span> <span class="n">fix</span><span class="p">,</span> <span class="n">fixFirstStation</span><span class="p">):</span>
    <span class="n">space</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
    <span class="k">if</span> <span class="n">fix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fixchar</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
    <span class="k">elif</span> <span class="n">fix</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fixchar</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="k">elif</span> <span class="n">fix</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">fixchar</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
    <span class="k">elif</span> <span class="n">fix</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">fixchar</span> <span class="o">=</span> <span class="s1">&#39;O&#39;</span>
    <span class="n">UTC</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">everow</span><span class="o">.</span><span class="n">TIME</span><span class="p">)</span>
    <span class="n">iws</span> <span class="o">=</span> <span class="n">UTC</span><span class="o">.</span><span class="n">format_iris_web_service</span><span class="p">()</span>
    <span class="n">hhmmssss</span> <span class="o">=</span> <span class="n">_killChars</span><span class="p">(</span><span class="n">iws</span><span class="p">)[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fixFirstStation</span><span class="p">:</span>
        <span class="n">lat</span><span class="p">,</span> <span class="n">latmin</span><span class="p">,</span> <span class="n">latchar</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lonmin</span><span class="p">,</span> <span class="n">lonchar</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lat</span><span class="p">,</span> <span class="n">latmin</span><span class="p">,</span> <span class="n">latchar</span> <span class="o">=</span> <span class="n">_returnLat</span><span class="p">(</span><span class="n">everow</span><span class="o">.</span><span class="n">LAT</span><span class="p">)</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lonmin</span><span class="p">,</span> <span class="n">lonchar</span> <span class="o">=</span> <span class="n">_returnLon</span><span class="p">(</span><span class="n">everow</span><span class="o">.</span><span class="n">LON</span><span class="p">)</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%05.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">everow</span><span class="o">.</span><span class="n">DEPTH</span>
    <span class="n">endline</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&lt;6}{:&lt;8}{:&lt;3}{:&lt;4}{:&lt;4}{:&lt;4}{:&lt;5}{:&lt;1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">space</span><span class="p">,</span> <span class="n">hhmmssss</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">latmin</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lonmin</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">fixchar</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">endline</span>


<div class="viewcode-block" id="makeHypoInverseStationFile"><a class="viewcode-back" href="../../detex.html#detex.util.makeHypoInverseStationFile">[docs]</a><span class="k">def</span> <span class="nf">makeHypoInverseStationFile</span><span class="p">(</span><span class="n">stationKey</span><span class="p">,</span> <span class="n">outname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a hypoinverse station file as defined in station data format #2,</span>
<span class="sd">    p. 30 of hyp1.41 user&#39;s manual</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    stationKey : str or DataFrame</span>
<span class="sd">        Path to station key csv or loaded dataframe with required columns</span>
<span class="sd">    outname : str</span>
<span class="sd">        The file to write</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stafil</span><span class="p">:</span>
        <span class="n">stakey</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">stationKey</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;station&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">srow</span> <span class="ow">in</span> <span class="n">stakey</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">srow</span><span class="o">.</span><span class="n">NETWORK</span>
            <span class="n">sta</span> <span class="o">=</span> <span class="n">srow</span><span class="o">.</span><span class="n">STATION</span>
            <span class="n">chans</span> <span class="o">=</span> <span class="n">srow</span><span class="o">.</span><span class="n">CHANNELS</span>
            <span class="n">latd</span><span class="p">,</span> <span class="n">latm</span><span class="p">,</span> <span class="n">latc</span> <span class="o">=</span> <span class="n">_returnLat</span><span class="p">(</span><span class="n">srow</span><span class="o">.</span><span class="n">LAT</span><span class="p">,</span> <span class="n">degPre</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">lond</span><span class="p">,</span> <span class="n">lonm</span><span class="p">,</span> <span class="n">lonc</span> <span class="o">=</span> <span class="n">_returnLon</span><span class="p">(</span><span class="n">srow</span><span class="o">.</span><span class="n">LON</span><span class="p">,</span> <span class="n">degPre</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">ele</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%4d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">srow</span><span class="o">.</span><span class="n">ELEVATION</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">chans</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="n">li</span> <span class="o">=</span> <span class="n">_makeInvStaLine</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">lond</span><span class="p">,</span> <span class="n">lonm</span><span class="p">,</span> <span class="n">lonc</span><span class="p">,</span> <span class="n">latd</span><span class="p">,</span>
                                     <span class="n">latm</span><span class="p">,</span> <span class="n">latc</span><span class="p">,</span> <span class="n">ele</span><span class="p">)</span>
                <span class="n">stafil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">li</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_makeInvStaLine</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">lond</span><span class="p">,</span> <span class="n">lonm</span><span class="p">,</span> <span class="n">lonc</span><span class="p">,</span> <span class="n">latd</span><span class="p">,</span>
                    <span class="n">latm</span><span class="p">,</span> <span class="n">latc</span><span class="p">,</span> <span class="n">ele</span><span class="p">):</span>
    <span class="n">chco</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>  <span class="c1"># optional 1 letter chan code</span>
    <span class="n">fstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&lt;6}{:&lt;3}{:&lt;1}{:&lt;5}{:&lt;3}{:&lt;7}{:&lt;1}{:&lt;4}{:&lt;7}{:&lt;1}{:&lt;4}</span><span class="s2">&quot;</span>
    <span class="n">sto</span> <span class="o">=</span> <span class="n">fstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">chco</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">latd</span><span class="p">,</span> <span class="n">latm</span><span class="p">,</span> <span class="n">latc</span><span class="p">,</span> <span class="n">lond</span><span class="p">,</span>
                      <span class="n">lonm</span><span class="p">,</span> <span class="n">lonc</span><span class="p">,</span> <span class="n">ele</span><span class="p">)</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="s1">&#39;5.0  P  0.00  0.00  0.00  0.00 0  0.00--&#39;</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{:&lt;86}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sto</span> <span class="o">+</span> <span class="n">ends</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>


<div class="viewcode-block" id="readHypo2000Sum"><a class="viewcode-back" href="../../detex.html#detex.util.readHypo2000Sum">[docs]</a><span class="k">def</span> <span class="nf">readHypo2000Sum</span><span class="p">(</span><span class="n">sumfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read a sum file from hyp2000 and return DataFrame with info loaded into,</span>
<span class="sd">    you guessed it, a DataFrame</span>

<span class="sd">    Parameters</span>
<span class="sd">    --------------</span>
<span class="sd">    sumfile : str</span>
<span class="sd">        Path to the summary file to read</span>

<span class="sd">    Read a sum file from hyp2000 and return lat, long, depth, mag, and RMS and</span>
<span class="sd">    TSTMP as pd dataframe</span>
<span class="sd">    WARNING : Assumes western hemisphere</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">sumfile</span><span class="p">)]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lat&#39;</span><span class="p">,</span> <span class="s1">&#39;Lon&#39;</span><span class="p">,</span> <span class="s1">&#39;DateString&#39;</span><span class="p">,</span> <span class="s1">&#39;Dep&#39;</span><span class="p">,</span> <span class="s1">&#39;RMS&#39;</span><span class="p">,</span> <span class="s1">&#39;ELAz&#39;</span><span class="p">,</span> <span class="s1">&#39;HozError&#39;</span><span class="p">,</span>
            <span class="s1">&#39;VertError&#39;</span><span class="p">]</span>
    <span class="n">DF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">DF</span><span class="o">.</span><span class="n">Lat</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">+</span>
                                        <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">21</span><span class="p">:</span><span class="mi">23</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>

        <span class="n">DF</span><span class="o">.</span><span class="n">Lon</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">29</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">+</span>
                                         <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">29</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>

        <span class="n">DF</span><span class="o">.</span><span class="n">DateString</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;T&#39;</span> <span class="o">+</span>
                            <span class="n">l</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">+</span>
                            <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>

        <span class="n">DF</span><span class="o">.</span><span class="n">Dep</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">34</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">34</span><span class="p">:</span><span class="mi">36</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">DF</span><span class="o">.</span><span class="n">RMS</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">48</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">+</span>
                     <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">50</span><span class="p">:</span><span class="mi">52</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">DF</span><span class="o">.</span><span class="n">HozError</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">85</span><span class="p">:</span><span class="mi">87</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">+</span>
                          <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">87</span><span class="p">:</span><span class="mi">89</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>

        <span class="n">DF</span><span class="o">.</span><span class="n">VertError</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">89</span><span class="p">:</span><span class="mi">91</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">+</span>
                           <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">91</span><span class="p">:</span><span class="mi">93</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DF</span></div>


<div class="viewcode-block" id="readHypo71Sum"><a class="viewcode-back" href="../../detex.html#detex.util.readHypo71Sum">[docs]</a><span class="k">def</span> <span class="nf">readHypo71Sum</span><span class="p">(</span><span class="n">sumfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a summary file from hypoinverse in the y2k compliant hypo71</span>
<span class="sd">    format</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sumfile : str</span>
<span class="sd">        Path the the sum file</span>

<span class="sd">    Returns</span>
<span class="sd">    -----------</span>
<span class="sd">    DataFrame populated with sumfile info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fw</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span> <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span> <span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="mi">38</span><span class="p">),</span>
          <span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span> <span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="mi">55</span><span class="p">),</span> <span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">59</span><span class="p">),</span> <span class="p">(</span><span class="mi">59</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">69</span><span class="p">),</span> <span class="p">(</span><span class="mi">69</span><span class="p">,</span> <span class="mi">74</span><span class="p">),</span> <span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">79</span><span class="p">)]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;latd&#39;</span><span class="p">,</span> <span class="s1">&#39;latc&#39;</span><span class="p">,</span> <span class="s1">&#39;latm&#39;</span><span class="p">,</span> <span class="s1">&#39;lond&#39;</span><span class="p">,</span> <span class="s1">&#39;lonc&#39;</span><span class="p">,</span> <span class="s1">&#39;lonm&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span>
            <span class="s1">&#39;numphase&#39;</span><span class="p">,</span> <span class="s1">&#39;azgap&#39;</span><span class="p">,</span> <span class="s1">&#39;stadist&#39;</span><span class="p">,</span> <span class="s1">&#39;rms&#39;</span><span class="p">,</span> <span class="s1">&#39;horerr&#39;</span><span class="p">,</span> <span class="s1">&#39;vererr&#39;</span><span class="p">]</span>
    <span class="n">toDrop</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;latd&#39;</span><span class="p">,</span> <span class="s1">&#39;latc&#39;</span><span class="p">,</span> <span class="s1">&#39;latm&#39;</span><span class="p">,</span> <span class="s1">&#39;lond&#39;</span><span class="p">,</span> <span class="s1">&#39;lonc&#39;</span><span class="p">,</span> <span class="s1">&#39;lonm&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_fwf</span><span class="p">(</span><span class="n">sumfile</span><span class="p">,</span> <span class="n">colspecs</span><span class="o">=</span><span class="n">fw</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

    <span class="n">latmul</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;latc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;latd&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;latm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">),</span> <span class="n">latmul</span><span class="p">)</span>
    <span class="n">lonmul</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lonc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lond&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lonm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">),</span> <span class="n">lonmul</span><span class="p">)</span>
    <span class="n">utcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">ds</span><span class="p">]</span>
    <span class="n">irisws</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">format_iris_web_service</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">utcs</span><span class="p">]</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">utcs</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">irisws</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">times</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">toDrop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="c1">########## NonLinLoc Functions ##############</span>

<div class="viewcode-block" id="writePhaseNLL"><a class="viewcode-back" href="../../detex.html#detex.util.writePhaseNLL">[docs]</a><span class="k">def</span> <span class="nf">writePhaseNLL</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="n">evekey</span><span class="p">,</span> <span class="n">NLLoc_dir</span><span class="p">,</span> <span class="n">useP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useS</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a y2k complient phase file used by hypoinverse 2000, format defined</span>
<span class="sd">    on page 113 of the manual for version 1.39</span>
<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    phases : pandas dataframe or path to csv</span>
<span class="sd">        Phase input from AssociatePhases script</span>
<span class="sd">    evekey : pandas dataframe or csv</span>
<span class="sd">        Event info</span>
<span class="sd">    outname : str</span>
<span class="sd">        File name (path) to write</span>
<span class="sd">    useP : bool</span>
<span class="sd">        If true write P phases</span>
<span class="sd">    useS : bool</span>
<span class="sd">        If true write S phases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evekey</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">evekey</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">evekey</span><span class="p">)</span>

    <span class="c1">## Split files if more than 100 events</span>


    <span class="k">for</span> <span class="n">eveind</span><span class="p">,</span> <span class="n">everow</span> <span class="ow">in</span> <span class="n">evekey</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  <span class="c1"># Loop events</span>

        <span class="n">on</span> <span class="o">=</span> <span class="n">everow</span><span class="o">.</span><span class="n">NAME</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.p&#39;</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NLLoc_dir</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">phafil</span><span class="p">:</span>
            <span class="n">phas</span> <span class="o">=</span> <span class="n">phases</span><span class="p">[</span><span class="n">phases</span><span class="o">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">everow</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phas</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># got to nect event if no phase info</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">phaind</span><span class="p">,</span> <span class="n">pha</span> <span class="ow">in</span> <span class="n">phas</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">Ppick</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">pha</span><span class="o">.</span><span class="n">ptime</span><span class="p">)</span>
                <span class="n">Spick</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">pha</span><span class="o">.</span><span class="n">stime</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Ppick</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Ppick</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">useP</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">_makeNLLine</span><span class="p">(</span><span class="n">pha</span><span class="p">,</span> <span class="n">everow</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">)</span>
                    <span class="n">phafil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Spick</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Spick</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">useS</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">_makeNLLine</span><span class="p">(</span><span class="n">pha</span><span class="p">,</span> <span class="n">everow</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">)</span>
                    <span class="n">phafil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">phafil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_makeNLLine</span><span class="p">(</span><span class="n">pha</span><span class="p">,</span> <span class="n">everow</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
        <span class="n">utc</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">pha</span><span class="o">.</span><span class="n">ptime</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
        <span class="n">utc</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">pha</span><span class="o">.</span><span class="n">stime</span><span class="p">)</span>
    <span class="n">staname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-6s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pha</span><span class="o">.</span><span class="n">station</span>
    <span class="n">inst</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-4s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;?&#39;</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-4s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;?&#39;</span>
    <span class="n">ponset</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;?&#39;</span>
    <span class="n">pdes</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-6s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">phase</span>
    <span class="n">fmot</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;?&#39;</span>
    <span class="n">ymd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%04d%02d%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">utc</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">utc</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">utc</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">hm</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02d%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">utc</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">utc</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>
    <span class="n">sec</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%07.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">utc</span><span class="o">.</span><span class="n">second</span><span class="p">)</span> <span class="o">+</span> <span class="n">utc</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">/</span> <span class="mf">1000000.</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-3s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;GAU&#39;</span>
    <span class="c1"># errMag = &#39;%9.2e&#39; % ermag</span>
    <span class="n">errMag</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-9s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;.01&#39;</span>
    <span class="n">codadur</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%9.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%9.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">per</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%9.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">oustr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">staname</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">ponset</span><span class="p">,</span> <span class="n">pdes</span><span class="p">,</span> <span class="n">fmot</span><span class="p">,</span> <span class="n">ymd</span><span class="p">,</span> <span class="n">hm</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span>
                      <span class="n">err</span><span class="p">,</span> <span class="n">errMag</span><span class="p">,</span> <span class="n">codadur</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">per</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">oustr</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>


<span class="c1">################# Read/Create detex key files ###################</span>

<span class="c1"># required key stuff</span>
<span class="n">req_temkey</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;LAT&#39;</span><span class="p">,</span> <span class="s1">&#39;LON&#39;</span><span class="p">,</span> <span class="s1">&#39;MAG&#39;</span><span class="p">,</span> <span class="s1">&#39;DEPTH&#39;</span><span class="p">])</span>
<span class="n">req_stakey</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;NETWORK&#39;</span><span class="p">,</span> <span class="s1">&#39;STATION&#39;</span><span class="p">,</span> <span class="s1">&#39;STARTTIME&#39;</span><span class="p">,</span> <span class="s1">&#39;ENDTIME&#39;</span><span class="p">,</span> <span class="s1">&#39;LAT&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;LON&#39;</span><span class="p">,</span> <span class="s1">&#39;ELEVATION&#39;</span><span class="p">,</span> <span class="s1">&#39;CHANNELS&#39;</span><span class="p">])</span>
<span class="n">req_phases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;TimeStamp&#39;</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">,</span> <span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="s1">&#39;Phase&#39;</span><span class="p">])</span>
<span class="n">req_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">req_temkey</span><span class="p">,</span> <span class="s1">&#39;station&#39;</span><span class="p">:</span> <span class="n">req_stakey</span><span class="p">,</span>
               <span class="s1">&#39;phases&#39;</span><span class="p">:</span> <span class="n">req_phases</span><span class="p">}</span>


<div class="viewcode-block" id="readKey"><a class="viewcode-back" href="../../detex.html#detex.util.readKey">[docs]</a><span class="k">def</span> <span class="nf">readKey</span><span class="p">(</span><span class="n">dfkey</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a template key csv and perform checks for required columns</span>
<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    dfkey : str or pandas DataFrame</span>
<span class="sd">        A path to the template key csv or the DataFrame itself</span>
<span class="sd">    key_type : str</span>
<span class="sd">        &quot;template&quot; for template key or &quot;station&quot; for station key</span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    A pandas DataFrame if required columns exist, else raise Exception</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># key types and required columns</span>

    <span class="n">key_types</span> <span class="o">=</span> <span class="n">req_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">key_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_types</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;unsported key type, supported types are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key_types</span><span class="p">)</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dfkey</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dfkey</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not exists, check path&#39;</span> <span class="o">%</span> <span class="n">dfkey</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dfkey</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dfkey</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">dfkey</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Data type of dfkey not understood&#39;</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

    <span class="c1"># Check required columns</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req_columns</span><span class="p">[</span><span class="n">key_type</span><span class="p">]</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Required columns not in </span><span class="si">%s</span><span class="s1">, required columns for </span><span class="si">%s</span><span class="s1"> key are </span><span class="si">%s</span><span class="s1">&#39;</span>
               <span class="o">%</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span> <span class="n">req_columns</span><span class="p">[</span><span class="n">key_type</span><span class="p">]))</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

    <span class="n">tdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="nb">list</span><span class="p">(</span><span class="n">req_columns</span><span class="p">[</span><span class="n">key_type</span><span class="p">])]</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="p">[</span><span class="nb">all</span><span class="p">([</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
                 <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span>

    <span class="c1"># TODO if column TIME is utcDateTime object sorting fails, fix this</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">req_columns</span><span class="p">[</span><span class="n">key_type</span><span class="p">]),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># specific operations for various key types</span>
    <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;station&#39;</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;STATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;STATION&#39;</span><span class="p">]]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;NETWORK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;NETWORK&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="inventory2StationKey"><a class="viewcode-back" href="../../detex.html#detex.util.inventory2StationKey">[docs]</a><span class="k">def</span> <span class="nf">inventory2StationKey</span><span class="p">(</span><span class="n">inv</span><span class="p">,</span> <span class="n">starttime</span><span class="p">,</span> <span class="n">endtime</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to create a station key from an obspy station inventory</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inv : an obspy.core.inventory.Inventory instance</span>
<span class="sd">        The inventory to use to create the station key, level of inventory</span>
<span class="sd">        must be at least &quot;channel&quot;</span>
<span class="sd">    starttime : obspy.UTCDateTime instance</span>
<span class="sd">        The start time to be written to station key</span>
<span class="sd">    endtime : obspy.UTCDateTime instance</span>
<span class="sd">        The end time to be written to the station key</span>
<span class="sd">    fileName : None or str</span>
<span class="sd">        If str then path to file to save (as csv), default name is</span>
<span class="sd">        StationKey.csv</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A pandas DataFrame of the station key</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># input checks</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inv</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;inv must be an obspy Inventory instance&#39;</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;starttime must be an obspy.UTCDateTime instance&#39;</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">endtime</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;endtime must be an obspy.UTCDateTime instance&#39;</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">starttime</span> <span class="o">&gt;=</span> <span class="n">endtime</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;starttime must be less than endtime&#39;</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">inv</span><span class="o">.</span><span class="n">get_contents</span><span class="p">()</span>  <span class="c1"># get contents</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Either no channels were found or inventory level is not at &#39;</span>
               <span class="s1">&#39;least &quot;channel&quot;, try recreating the inventory using &#39;</span>
               <span class="s1">&#39;level=&quot;channel&quot;&#39;</span><span class="p">)</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="c1"># Init DataFrame</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NETWORK&#39;</span><span class="p">,</span> <span class="s1">&#39;STATION&#39;</span><span class="p">,</span> <span class="s1">&#39;STARTTIME&#39;</span><span class="p">,</span> <span class="s1">&#39;ENDTIME&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LAT&#39;</span><span class="p">,</span> <span class="s1">&#39;LON&#39;</span><span class="p">,</span> <span class="s1">&#39;ELEVATION&#39;</span><span class="p">,</span> <span class="s1">&#39;CHANNELS&#39;</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">])),</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
    <span class="c1"># Iter inv</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">stime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">etime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="n">inv</span><span class="p">:</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">code</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">net</span><span class="p">:</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">latitude</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">longitude</span>
            <span class="n">ele</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">elevation</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">code</span>
            <span class="n">chanlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">sta</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>
                <span class="n">chanlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="n">chanlist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chanlist</span><span class="p">)</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nc</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">stime</span><span class="p">,</span> <span class="n">etime</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">ele</span><span class="p">,</span> <span class="n">cs</span><span class="p">])</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="templateKey2Catalog"><a class="viewcode-back" href="../../detex.html#detex.util.templateKey2Catalog">[docs]</a><span class="k">def</span> <span class="nf">templateKey2Catalog</span><span class="p">(</span><span class="n">temkey</span><span class="o">=</span><span class="s1">&#39;TemplateKey.csv&#39;</span><span class="p">,</span> <span class="n">picks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to convert a templatekey and optionally a phase picks file to</span>
<span class="sd">    an obspy catalog instance</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    temeky : str, pd.DataFrame</span>
<span class="sd">        The standard template key (or path to it)</span>
<span class="sd">    picks : str, pd.DataFrame</span>
<span class="sd">        A picks file in same format as created by pickPhases</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    An Obspy.Catalog object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temkey</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">temkey</span><span class="p">,</span> <span class="s2">&quot;template&quot;</span><span class="p">)</span>
    <span class="n">picks</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">picks</span><span class="p">,</span> <span class="s1">&#39;phases&#39;</span><span class="p">)</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Catalog</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">temkey</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_getEvents</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">picks</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cat</span></div>


<span class="k">def</span> <span class="nf">_getEvents</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">picks</span><span class="p">):</span>
    <span class="n">eve</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">eve</span><span class="o">.</span><span class="n">magnitudes</span> <span class="o">=</span> <span class="n">_getMagnitudes</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">eve</span><span class="o">.</span><span class="n">origins</span> <span class="o">=</span> <span class="n">_getOrigins</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">eve</span><span class="o">.</span><span class="n">picks</span> <span class="o">=</span> <span class="n">_getPicks</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">picks</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eve</span>


<span class="k">def</span> <span class="nf">_getMagnitudes</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Magnitude</span><span class="p">()</span>
    <span class="n">mag</span><span class="o">.</span><span class="n">mag</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">MAG</span>
    <span class="k">if</span> <span class="s1">&#39;MTYPE&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">mag</span><span class="o">.</span><span class="n">magnitude_type</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">MTYPE</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">mag</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_getOrigins</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">LAT</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">LON</span>
    <span class="n">dep</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">DEPTH</span>
    <span class="n">ori</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Origin</span>
    <span class="n">ori</span><span class="o">.</span><span class="n">lattitude</span> <span class="o">=</span> <span class="n">lat</span>
    <span class="n">ori</span><span class="o">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="n">lon</span>
    <span class="n">ori</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">dep</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ori</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_getPicks</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">picks</span><span class="p">):</span>
    <span class="n">phases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">picks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">phases</span>
    <span class="n">phs</span> <span class="o">=</span> <span class="n">picks</span><span class="p">[</span><span class="n">picks</span><span class="o">.</span><span class="n">Event</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">phind</span><span class="p">,</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">phs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_getPick</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ph</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">phases</span>


<span class="k">def</span> <span class="nf">_getPick</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ph</span><span class="p">):</span>
    <span class="n">pick</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Pick</span><span class="p">()</span>
    <span class="n">pick</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">TimeStamp</span><span class="p">)</span>
    <span class="n">pick</span><span class="o">.</span><span class="n">phase_hint</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">Phase</span>
    <span class="k">return</span> <span class="n">pick</span>


<div class="viewcode-block" id="EQSearch2TemplateKey"><a class="viewcode-back" href="../../detex.html#detex.util.EQSearch2TemplateKey">[docs]</a><span class="k">def</span> <span class="nf">EQSearch2TemplateKey</span><span class="p">(</span><span class="n">eq</span><span class="o">=</span><span class="s1">&#39;eqsrchsum&#39;</span><span class="p">,</span> <span class="n">oname</span><span class="o">=</span><span class="s1">&#39;eqTemplateKey.csv&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a template key from the eqsearch sum file (produced by the</span>
<span class="sd">    University of Utah seismograph stations code EQsearch)</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    eq : str</span>
<span class="sd">        eqsearch sum. file</span>
<span class="sd">    oname : str</span>
<span class="sd">        name of the template key</span>
<span class="sd">    Notes</span>
<span class="sd">    -------------</span>
<span class="sd">    Code assimes any year code above 50 belongs to 1900, and any year code</span>
<span class="sd">    less than 50 belongs to 2000 (since eqsrchsum is not y2k compliant)</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="n">clspecs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span>
               <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span> <span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">36</span><span class="p">),</span> <span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="mi">43</span><span class="p">),</span> <span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="mi">50</span><span class="p">)]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;mo&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;latdeg&#39;</span><span class="p">,</span> <span class="s1">&#39;latmin&#39;</span><span class="p">,</span>
             <span class="s1">&#39;londeg&#39;</span><span class="p">,</span> <span class="s1">&#39;lonmin&#39;</span><span class="p">,</span> <span class="s1">&#39;dep&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_fwf</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">colspecs</span><span class="o">=</span><span class="n">clspecs</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;19</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;20</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]]</span>
    <span class="n">month</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mo&#39;</span><span class="p">]]</span>
    <span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]]</span>
    <span class="n">hr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hr&#39;</span><span class="p">]]</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]]</span>
    <span class="n">second</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%05.02f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">]]</span>
    <span class="n">TIME</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">T</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="n">x6</span><span class="p">)</span> <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="n">x6</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hr</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)]</span>
    <span class="n">Lat</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;latdeg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;latmin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="mf">60.0</span>
    <span class="n">Lon</span> <span class="o">=</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;londeg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lonmin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="mf">60.0</span>

    <span class="n">DF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">DF</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIME</span>
    <span class="n">DF</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIME</span>
    <span class="n">DF</span><span class="p">[</span><span class="s1">&#39;LAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lat</span>
    <span class="n">DF</span><span class="p">[</span><span class="s1">&#39;LON&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lon</span>
    <span class="n">DF</span><span class="p">[</span><span class="s1">&#39;MAG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>
    <span class="n">DF</span><span class="p">[</span><span class="s1">&#39;DEPTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dep&#39;</span><span class="p">]</span>
    <span class="n">DF</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">oname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DF</span></div>


<div class="viewcode-block" id="catalog2Templatekey"><a class="viewcode-back" href="../../detex.html#detex.util.catalog2Templatekey">[docs]</a><span class="k">def</span> <span class="nf">catalog2Templatekey</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to get build the Detex required file TemplateKey.csv</span>
<span class="sd">    from an obspy catalog object</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    catalog : instance of obspy.core.event.Catalog</span>
<span class="sd">        The catalog to use in the template key creation</span>
<span class="sd">    filename : str or None</span>
<span class="sd">        If None no file is saved, if str then path to the template key to</span>
<span class="sd">        save. Default is StationKey.csv.</span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    A pandas DataFrame of the template key information found in the</span>
<span class="sd">    catalog object</span>

<span class="sd">    Notes</span>
<span class="sd">    -------</span>
<span class="sd">    obspy catalog object docs at:</span>
<span class="sd">    http://docs.obspy.org/packages/autogen/obspy.fdsn.client.Client.get_events</span>
<span class="sd">    .html#obspy.fdsn.client.Client.get_events</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Catalog</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;input is not an obspy catalog object&#39;</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="s1">&#39;LAT&#39;</span><span class="p">,</span> <span class="s1">&#39;LON&#39;</span><span class="p">,</span> <span class="s1">&#39;DEPTH&#39;</span><span class="p">,</span> <span class="s1">&#39;MAG&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;CONTRIBUTOR&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">evenum</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">origins</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Event &#39;</span><span class="si">%s</span><span class="s2">&#39; does not have an origin&quot;</span> <span class="o">%</span>
                   <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">resource_id</span><span class="p">))</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">magnitudes</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Event &#39;</span><span class="si">%s</span><span class="s2">&#39; does not have a magnitude&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">resource_id</span><span class="p">))</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">preferred_origin</span><span class="p">()</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">origins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">latitude</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">longitude</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">depth</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="n">time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">origin</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">preferred_magnitude</span><span class="p">()</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">magnitudes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">mag</span>
        <span class="n">magty</span> <span class="o">=</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">magnitude_type</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">creation_info</span><span class="o">.</span><span class="n">author</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">magty</span><span class="p">,</span> <span class="n">auth</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">evenum</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="saveSQLite"><a class="viewcode-back" href="../../detex.html#detex.util.saveSQLite">[docs]</a><span class="k">def</span> <span class="nf">saveSQLite</span><span class="p">(</span><span class="n">DF</span><span class="p">,</span> <span class="n">CorDB</span><span class="p">,</span> <span class="n">Tablename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic function to save pandas dataframe to SQL</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    DF : pandas DataFrame</span>
<span class="sd">        The data frame instance to save</span>
<span class="sd">    CorDB : str</span>
<span class="sd">        Path to the database</span>
<span class="sd">    Tablename : str</span>
<span class="sd">        Name of the table to which DF will be saved</span>
<span class="sd">    silent : bool</span>
<span class="sd">        If True will suppress the any messages from database writing</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">CorDB</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CorDB</span><span class="p">):</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">pandas_dbms</span><span class="o">.</span><span class="n">write_frame</span><span class="p">(</span>
                <span class="n">DF</span><span class="p">,</span> <span class="n">Tablename</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;sqlite&#39;</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">pandas_dbms</span><span class="o">.</span><span class="n">write_frame</span><span class="p">(</span>
                <span class="n">DF</span><span class="p">,</span> <span class="n">Tablename</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;sqlite&#39;</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="loadSQLite"><a class="viewcode-back" href="../../detex.html#detex.util.loadSQLite">[docs]</a><span class="k">def</span> <span class="nf">loadSQLite</span><span class="p">(</span><span class="n">corDB</span><span class="p">,</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">sql</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">readExcpetion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">convertNumeric</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to load sqlite database</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    corDB : str</span>
<span class="sd">        Path to the database</span>
<span class="sd">    tablename : str</span>
<span class="sd">        Table to load from sqlite database</span>
<span class="sd">    sql : str</span>
<span class="sd">        sql arguments to pass directly to database query</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A pandas dataframe with loaded table or None if DB or table does not exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># try:</span>
    <span class="k">if</span> <span class="n">sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT </span><span class="si">%s</span><span class="s1"> FROM </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">tableName</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">corDB</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">psql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;read_sql returned the following error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">convertNumeric</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">ser</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">serConverted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">ser</span><span class="p">)</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">serConverted</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="loadClusters"><a class="viewcode-back" href="../../detex.html#detex.util.loadClusters">[docs]</a><span class="k">def</span> <span class="nf">loadClusters</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;clust.pkl&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that uses pandas.read_pickle to load a pickled cluster</span>
<span class="sd">    (instance of detex.subspace.ClusterStream)</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the saved cluster isntance</span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    An instance of detex.subspace.ClusterStream</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cl</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">detex</span><span class="o">.</span><span class="n">subspace</span><span class="o">.</span><span class="n">ClusterStream</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a ClusterStream instance&#39;</span> <span class="o">%</span> <span class="n">filename</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cl</span></div>


<div class="viewcode-block" id="loadSubSpace"><a class="viewcode-back" href="../../detex.html#detex.util.loadSubSpace">[docs]</a><span class="k">def</span> <span class="nf">loadSubSpace</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;subspace.pkl&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that uses pandas.read_pickle to load a pickled subspace</span>
<span class="sd">    (instance of detex.subspace.SubSpaceStream)</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the saved subspace instance</span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    An instance of detex.subspace.SubSpaceStream</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">detex</span><span class="o">.</span><span class="n">subspace</span><span class="o">.</span><span class="n">SubSpace</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a SubSpaceStream instance&#39;</span> <span class="o">%</span> <span class="n">filename</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ss</span></div>


<div class="viewcode-block" id="readLog"><a class="viewcode-back" href="../../detex.html#detex.util.readLog">[docs]</a><span class="k">def</span> <span class="nf">readLog</span><span class="p">(</span><span class="n">logpath</span><span class="o">=</span><span class="s1">&#39;detex_log.log&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the standard detex log into a dataframe. Columns are: Time, Mod,</span>
<span class="sd">    Level, and Msg.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    logpath : str</span>
<span class="sd">        Path the the log file</span>

<span class="sd">    Returns</span>
<span class="sd">    -----------</span>
<span class="sd">    DataFrame with log info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">logpath</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;Mod&#39;</span><span class="p">,</span> <span class="s1">&#39;Level&#39;</span><span class="p">,</span> <span class="s1">&#39;Msg&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="c1">###################### Data processing functions ###########################</span>

<div class="viewcode-block" id="get_number_channels"><a class="viewcode-back" href="../../detex.html#detex.util.get_number_channels">[docs]</a><span class="k">def</span> <span class="nf">get_number_channels</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take an obspy stream and get the number of unique channels in stream</span>
<span class="sd">    (stream must have only one station)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">st</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;function only takes streams with exactly 1 station&#39;</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">st</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">nc</span></div>


<span class="c1">############################## Phase Picker ############################</span>

<div class="viewcode-block" id="pickPhases"><a class="viewcode-back" href="../../detex.html#detex.util.pickPhases">[docs]</a><span class="k">def</span> <span class="nf">pickPhases</span><span class="p">(</span><span class="n">fetch</span><span class="o">=</span><span class="s1">&#39;EventWaveForms&#39;</span><span class="p">,</span> <span class="n">templatekey</span><span class="o">=</span><span class="s1">&#39;TemplateKey.csv&#39;</span><span class="p">,</span>
               <span class="n">stationkey</span><span class="o">=</span><span class="s1">&#39;StationKey.csv&#39;</span><span class="p">,</span> <span class="n">pickFile</span><span class="o">=</span><span class="s1">&#39;PhasePicks.csv&#39;</span><span class="p">,</span>
               <span class="n">skipIfExists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses streamPicks to parse the templates and allow user to manually pick</span>
<span class="sd">    phases for events. Only P,S, Pend, and Send are supported phases under</span>
<span class="sd">    the current GUI, but other phases can be manually input to this format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    EveDir : str</span>
<span class="sd">        Input to detex.getdata.quickFetch, defaults to using the default</span>
<span class="sd">        directory structure for</span>
<span class="sd">    templatekey : str or pandas DataFrame</span>
<span class="sd">        Path to the template key or template key loaded in DataFrame</span>
<span class="sd">    stationkey : str or pandas DataFrame</span>
<span class="sd">        Path to the station key or station key loaded in DataFrame</span>
<span class="sd">    pickFile : str</span>
<span class="sd">        Path to newly created csv containing phase times. If the file already</span>
<span class="sd">        exists it will be read so that picks already made do not have to be</span>
<span class="sd">        re-picked</span>
<span class="sd">    skipIfExists : bool</span>
<span class="sd">        If True skip any events/stations that already have any phase picks</span>
<span class="sd">    kwargs passed to quickFetch, see detex.getdata.quickFetch for details</span>
<span class="sd">    Notes</span>
<span class="sd">    ----------</span>
<span class="sd">    Required columns are : TimeStamp, Station, Event, Phase</span>
<span class="sd">    Station field is net.sta (eg TA.M17A)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temkey</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">templatekey</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
    <span class="n">stakey</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">stationkey</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;station&#39;</span><span class="p">)</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TimeStamp&#39;</span><span class="p">,</span> <span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">,</span> <span class="s1">&#39;Phase&#39;</span><span class="p">,</span> <span class="s1">&#39;Channel&#39;</span><span class="p">,</span> <span class="s1">&#39;Seconds&#39;</span><span class="p">]</span>
    <span class="n">fetcher</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">getdata</span><span class="o">.</span><span class="n">quickFetch</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">ets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># events to skip picking on</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># must init the PyQt app outside of the loop or else it kills python</span>
    <span class="n">qApp</span> <span class="o">=</span> <span class="n">PyQt4</span><span class="o">.</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># load pickfile if it exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pickFile</span><span class="p">):</span>
        <span class="n">DF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pickFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if empty then delete</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pickFile</span><span class="p">)</span>
            <span class="n">DF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skipIfExists</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">DF</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">Station</span> <span class="ow">in</span> <span class="n">ets</span><span class="p">:</span>
                        <span class="n">ets</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">ets</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">DF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">st</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">fetcher</span><span class="o">.</span><span class="n">getTemData</span><span class="p">(</span><span class="n">temkey</span><span class="p">,</span> <span class="n">stakey</span><span class="p">,</span> <span class="n">skipDict</span><span class="o">=</span><span class="n">ets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">st</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># skip if no data returned</span>
            <span class="k">continue</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># reload(detex.streamPick)</span>

        <span class="n">Pks</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># needed so OS X doesn&#39;t crash</span>
        <span class="n">Pks</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">streamPick</span><span class="o">.</span><span class="n">streamPick</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="n">qApp</span><span class="p">)</span>

        <span class="n">tdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">saveit</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># saveflag</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Pks</span><span class="o">.</span><span class="n">_picks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                <span class="n">tstamp</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;waveform_id&#39;</span><span class="p">][</span><span class="s1">&#39;channel_code&#39;</span><span class="p">]</span>
                <span class="n">tdict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">phase_hint</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tstamp</span><span class="p">,</span> <span class="n">chan</span><span class="p">]</span>
                <span class="n">saveit</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">saveit</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">stmp</span> <span class="o">=</span> <span class="n">tdict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="n">tdict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">secs</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%3.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stmp</span>
                <span class="n">sta</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
                <span class="n">di</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TimeStamp&#39;</span><span class="p">:</span> <span class="n">stmp</span><span class="p">,</span> <span class="s1">&#39;Station&#39;</span><span class="p">:</span> <span class="n">sta</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
                      <span class="s1">&#39;Phase&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;Channel&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;Seconds&#39;</span><span class="p">:</span> <span class="n">secs</span><span class="p">}</span>
                <span class="n">DF</span> <span class="o">=</span> <span class="n">DF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">di</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Pks</span><span class="o">.</span><span class="n">KeepGoing</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Exiting picking GUI, progress saved in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pickFile</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">pickFile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># save every 10 phase picks</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">pickFile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">DF</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">DF</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">DF</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">pickFile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="seeWaveFroms"><a class="viewcode-back" href="../../detex.html#detex.util.seeWaveFroms">[docs]</a><span class="k">def</span> <span class="nf">seeWaveFroms</span><span class="p">(</span><span class="n">fetch</span><span class="o">=</span><span class="s1">&#39;ContinuousWaveForms&#39;</span><span class="p">,</span> <span class="n">templatekey</span><span class="o">=</span><span class="s1">&#39;TemplateKey.csv&#39;</span><span class="p">,</span>
                 <span class="n">outFile</span><span class="o">=</span><span class="s1">&#39;PhasePicks.csv&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses streamPicks to parse the templates and allow user to manually pick</span>
<span class="sd">    phases for events. Only P,S, Pend, and Send are supported phases under</span>
<span class="sd">    the current GUI, but other phases can be manually input to this format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    fetch : str or instance of detex.getdata.DataFetcher</span>
<span class="sd">        Input to detex.getdata.quickFetch, defaults to using the default</span>
<span class="sd">        directory structure</span>
<span class="sd">    templatekey : str or pandas DataFrame</span>
<span class="sd">        Path to the template key or template key loaded in DataFrame</span>
<span class="sd">    outFile : str</span>
<span class="sd">        Path to newly created csv containing events (in df) as index and</span>
<span class="sd">        stations as columns</span>
<span class="sd">    ----------</span>
<span class="sd">    Required columns are : TimeStamp, Station, Event, Phase</span>
<span class="sd">    Station field is net.sta (eg TA.M17A)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temkey</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">templatekey</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
    <span class="n">stakey</span> <span class="o">=</span> <span class="n">readKey</span><span class="p">(</span><span class="n">stationkey</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;station&#39;</span><span class="p">)</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TimeStamp&#39;</span><span class="p">,</span> <span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">,</span> <span class="s1">&#39;Phase&#39;</span><span class="p">,</span> <span class="s1">&#39;Channel&#39;</span><span class="p">,</span> <span class="s1">&#39;Seconds&#39;</span><span class="p">]</span>
    <span class="n">fetcher</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">getdata</span><span class="o">.</span><span class="n">quickFetch</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">ets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># events to skip picking on</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># must init the PyQt app outside of the loop or else it kills python</span>
    <span class="n">qApp</span> <span class="o">=</span> <span class="n">PyQt4</span><span class="o">.</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># load pickfile if it exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pickFile</span><span class="p">):</span>
        <span class="n">DF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pickFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if empty then delete</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pickFile</span><span class="p">)</span>
            <span class="n">DF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skipIfExists</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">DF</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">Station</span> <span class="ow">in</span> <span class="n">ets</span><span class="p">:</span>
                        <span class="n">ets</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">ets</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">DF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">st</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">fetcher</span><span class="o">.</span><span class="n">getTemData</span><span class="p">(</span><span class="n">temkey</span><span class="p">,</span> <span class="n">stakey</span><span class="p">,</span> <span class="n">skipDict</span><span class="o">=</span><span class="n">ets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">st</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># skip if no data returned</span>
            <span class="k">continue</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># reload(detex.streamPick)</span>

        <span class="n">Pks</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># needed so OS X doesn&#39;t crash</span>
        <span class="n">Pks</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">streamPick</span><span class="o">.</span><span class="n">streamPick</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="n">qApp</span><span class="p">)</span>

        <span class="n">tdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">saveit</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># saveflag</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Pks</span><span class="o">.</span><span class="n">_picks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                <span class="n">tstamp</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;waveform_id&#39;</span><span class="p">][</span><span class="s1">&#39;channel_code&#39;</span><span class="p">]</span>
                <span class="n">tdict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">phase_hint</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tstamp</span><span class="p">,</span> <span class="n">chan</span><span class="p">]</span>
                <span class="n">saveit</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">saveit</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">stmp</span> <span class="o">=</span> <span class="n">tdict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="n">tdict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">secs</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%3.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stmp</span>
                <span class="n">sta</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
                <span class="n">di</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TimeStamp&#39;</span><span class="p">:</span> <span class="n">stmp</span><span class="p">,</span> <span class="s1">&#39;Station&#39;</span><span class="p">:</span> <span class="n">sta</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
                      <span class="s1">&#39;Phase&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;Channel&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;Seconds&#39;</span><span class="p">:</span> <span class="n">secs</span><span class="p">}</span>
                <span class="n">DF</span> <span class="o">=</span> <span class="n">DF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">di</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Pks</span><span class="o">.</span><span class="n">KeepGoing</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Exiting picking GUI, progress saved in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pickFile</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">pickFile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># save every 10 phase picks</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">pickFile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">DF</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="s1">&#39;Event&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">DF</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">DF</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">pickFile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<span class="c1">############### Misc functions</span>

<span class="k">def</span> <span class="nf">_killChars</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">charstokill</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">ctk</span> <span class="ow">in</span> <span class="n">charstokill</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ctk</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span>


<span class="k">def</span> <span class="nf">_returnLat</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">degPre</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    functon to take lattitude and return lattitude in hypo inverse format</span>
<span class="sd">    lat degrees, lat decimal minutes with degPre precision after decimal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">cha</span> <span class="o">=</span> <span class="s1">&#39;S&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cha</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
    <span class="c1"># cha = &#39; &#39;</span>
    <span class="c1"># take decimal degrees spit out degrees decimal minutes</span>
    <span class="n">latds</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&lt;2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
    <span class="n">latms</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;%4.&#39;</span> <span class="o">+</span> <span class="p">((</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">degPre</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;f&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">((</span><span class="n">lat</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">latds</span><span class="p">,</span> <span class="n">latms</span><span class="p">,</span> <span class="n">cha</span>


<span class="k">def</span> <span class="nf">_returnLon</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">degPre</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    functon to take longitude and return longitude in hypo inverse format</span>
<span class="sd">    lon degrees, lon decimal minutes with degPre precision after decimal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
        <span class="n">cha</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cha</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
        <span class="c1"># cha = &#39; &#39;</span>
    <span class="c1"># take decimal degrees spit out degrees decimal minutes</span>
    <span class="n">londs</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&lt;3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">lon</span><span class="p">))</span>
    <span class="n">lonms</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;%4.&#39;</span> <span class="o">+</span> <span class="p">((</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">degPre</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;f&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">((</span><span class="n">lon</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">lon</span><span class="p">))</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">londs</span><span class="p">,</span> <span class="n">lonms</span><span class="p">,</span> <span class="n">cha</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">detex</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../detex.html">detex package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../detex.html">detex</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Derrick Chambers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>