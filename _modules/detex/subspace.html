
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>detex.subspace &#8212; detex __version__ = 1.0.9 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for detex.subspace</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Jul 08 21:24:18 2014</span>

<span class="sd">@author: Derrick</span>
<span class="sd">Module containing import detex classes</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># python 2 and 3 compatibility imports</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">obspy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">string_types</span>

<span class="kn">import</span> <span class="nn">detex</span>

<span class="k">try</span><span class="p">:</span>  <span class="c1"># python 2/3 compat</span>
    <span class="kn">import</span> <span class="nn">cPickle</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span> <span class="k">as</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">colorsys</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="k">import</span> <span class="n">pack</span>
<span class="kn">import</span> <span class="nn">PyQt4</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="k">import</span> <span class="n">dendrogram</span><span class="p">,</span> <span class="n">fcluster</span>
<span class="kn">from</span> <span class="nn">detex.detect</span> <span class="k">import</span> <span class="n">_SSDetex</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># mute setting copy warning</span>

<span class="c1"># warnings.filterwarnings(&#39;error&#39;) #uncomment this to make all warnings errors</span>

<span class="c1"># lines for backward compat.</span>


<div class="viewcode-block" id="ClusterStream"><a class="viewcode-back" href="../../detex.html#detex.subspace.ClusterStream">[docs]</a><span class="k">class</span> <span class="nc">ClusterStream</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A container for multiple cluster objects, should only be called with</span>
<span class="sd">    detex.construct.createCluster</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trdf</span><span class="p">,</span> <span class="n">temkey</span><span class="p">,</span> <span class="n">stakey</span><span class="p">,</span> <span class="n">fetcher</span><span class="p">,</span> <span class="n">eventList</span><span class="p">,</span> <span class="n">ccReq</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span>
                 <span class="n">decimate</span><span class="p">,</span> <span class="n">trim</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">eventsOnAllStations</span><span class="p">,</span> <span class="n">enforceOrigin</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>  <span class="c1"># Instantiate all input variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccReq</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># set to None because it can vary between stations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">trdf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stalist</span> <span class="o">=</span> <span class="n">trdf</span><span class="o">.</span><span class="n">Station</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># station lists </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stalist2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stalist</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">fileName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventCodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeCodes</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">trdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">eventsOnAllStations</span><span class="p">:</span>
                <span class="n">evlist</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Events</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">evlist</span> <span class="o">=</span> <span class="n">eventList</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">,</span> <span class="n">temkey</span><span class="p">,</span> <span class="n">evlist</span><span class="p">,</span>
                                         <span class="n">row</span><span class="o">.</span><span class="n">Link</span><span class="p">,</span> <span class="n">ccReq</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">decimate</span><span class="p">,</span> <span class="n">trim</span><span class="p">,</span>
                                         <span class="n">row</span><span class="o">.</span><span class="n">CCs</span><span class="p">)</span>

<div class="viewcode-block" id="ClusterStream.writeSimpleHypoDDInput"><a class="viewcode-back" href="../../detex.html#detex.subspace.ClusterStream.writeSimpleHypoDDInput">[docs]</a>    <span class="k">def</span> <span class="nf">writeSimpleHypoDDInput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="s1">&#39;dt.cc&#39;</span><span class="p">,</span> <span class="n">coef</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minCC</span><span class="o">=.</span><span class="mi">35</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a hypoDD cross correlation file (EG dt.cc), assuming the lag </span>
<span class="sd">        times are pure S times (should be true if S amplitude is dominant)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileName : str</span>
<span class="sd">            THe path to the new file to be created</span>
<span class="sd">        coef : float or int</span>
<span class="sd">            The exponential coeficient to apply to the correlation </span>
<span class="sd">            coeficient when creating file, usefull to downweight lower cc </span>
<span class="sd">            values</span>
<span class="sd">       &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforceOrigin</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Sample Lags are not meaningful unless origin times are &#39;</span>
                   <span class="s1">&#39;enforced on each waveform. re-run detex.subspace.&#39;</span>
                   <span class="s1">&#39;createCluster with enforceOrigin=True&#39;</span><span class="p">)</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">fil</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="c1"># required number of zeros for numbering all events</span>
        <span class="n">reqZeros</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="p">))))</span>
        <span class="k">for</span> <span class="n">num1</span><span class="p">,</span> <span class="n">everow1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">num2</span><span class="p">,</span> <span class="n">everow2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">num1</span> <span class="o">&gt;=</span> <span class="n">num2</span><span class="p">:</span>  <span class="c1"># if autocors or redundant pair then skip</span>
                    <span class="k">continue</span>
                <span class="n">ev1</span><span class="p">,</span> <span class="n">ev2</span> <span class="o">=</span> <span class="n">everow1</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">everow2</span><span class="o">.</span><span class="n">NAME</span>
                <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeHeader</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">,</span> <span class="n">reqZeros</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stalist</span><span class="p">:</span>  <span class="c1"># iter through each station</span>
                    <span class="n">Clu</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># find station specific index for event1</span>
                        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Clu</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">ev1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Clu</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">ev2</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># if either event is not in index</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> or </span><span class="si">%s</span><span class="s1"> not found on station </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">ev1</span><span class="p">,</span> <span class="n">ev2</span><span class="p">,</span> <span class="n">sta</span><span class="p">))</span>
                        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># get data specific to this station</span>
                    <span class="n">trdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trdf</span><span class="o">.</span><span class="n">Station</span> <span class="o">==</span> <span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sr1</span> <span class="o">=</span> <span class="n">trdf</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">ev1</span><span class="p">][</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span>
                    <span class="n">sr2</span> <span class="o">=</span> <span class="n">trdf</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">ev2</span><span class="p">][</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sr1</span> <span class="o">!=</span> <span class="n">sr2</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Samp. rates not equal on </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ev1</span><span class="p">,</span> <span class="n">ev2</span><span class="p">)</span>
                        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sr</span> <span class="o">=</span> <span class="n">sr1</span>
                    <span class="n">Nc1</span><span class="p">,</span> <span class="n">Nc2</span> <span class="o">=</span> <span class="n">trdf</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">ev1</span><span class="p">][</span><span class="s1">&#39;Nc&#39;</span><span class="p">],</span> <span class="n">trdf</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">ev2</span><span class="p">][</span><span class="s1">&#39;Nc&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">Nc1</span> <span class="o">!=</span> <span class="n">Nc2</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Num. of channels not equal for </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">ev1</span><span class="p">,</span> <span class="n">ev2</span><span class="p">))</span>
                        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Nc</span> <span class="o">=</span> <span class="n">Nc1</span>
                    <span class="n">cc</span> <span class="o">=</span> <span class="n">trdf</span><span class="o">.</span><span class="n">CCs</span><span class="p">[</span><span class="n">ind2</span><span class="p">][</span><span class="n">ind1</span><span class="p">]</span>  <span class="c1"># get cc value</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cc</span><span class="p">):</span>  <span class="c1"># get other part of symetric matrix</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="n">trdf</span><span class="o">.</span><span class="n">CCs</span><span class="p">[</span><span class="n">ind1</span><span class="p">][</span><span class="n">ind2</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> pair not in CCs matrix&#39;</span> <span class="o">%</span>
                                   <span class="p">(</span><span class="n">ev1</span><span class="p">,</span> <span class="n">ev2</span><span class="p">))</span>
                            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cc</span><span class="p">):</span>  <span class="c1"># second pass required</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> pair returning NaN&#39;</span> <span class="o">%</span>
                                   <span class="p">(</span><span class="n">ev1</span><span class="p">,</span> <span class="n">ev2</span><span class="p">))</span>
                            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">cc</span> <span class="o">&lt;</span> <span class="n">minCC</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">lagsamps</span> <span class="o">=</span> <span class="n">trdf</span><span class="o">.</span><span class="n">Lags</span><span class="p">[</span><span class="n">ind2</span><span class="p">][</span><span class="n">ind1</span><span class="p">]</span>
                    <span class="n">subsamps</span> <span class="o">=</span> <span class="n">trdf</span><span class="o">.</span><span class="n">Subsamp</span><span class="p">[</span><span class="n">ind2</span><span class="p">][</span><span class="n">ind1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lagsamps</span><span class="p">):</span>  <span class="c1"># if lag from other end of mat</span>
                        <span class="n">lagsamps</span> <span class="o">=</span> <span class="o">-</span><span class="n">trdf</span><span class="o">.</span><span class="n">Lags</span><span class="p">[</span><span class="n">ind1</span><span class="p">][</span><span class="n">ind2</span><span class="p">]</span>
                        <span class="n">subsamps</span> <span class="o">=</span> <span class="n">trdf</span><span class="o">.</span><span class="n">Subsamp</span><span class="p">[</span><span class="n">ind1</span><span class="p">][</span><span class="n">ind2</span><span class="p">]</span>
                    <span class="n">lags</span> <span class="o">=</span> <span class="n">lagsamps</span> <span class="o">/</span> <span class="p">(</span><span class="n">sr</span> <span class="o">*</span> <span class="n">Nc</span><span class="p">)</span> <span class="o">+</span> <span class="n">subsamps</span>
                    <span class="n">obsline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeObsLine</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">lags</span><span class="p">,</span> <span class="n">cc</span> <span class="o">**</span> <span class="n">coef</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsline</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">fil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">fil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">obsline</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fil</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_makeObsLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">pha</span><span class="o">=</span><span class="s1">&#39;S&#39;</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%0.4f</span><span class="s1"> </span><span class="si">%0.4f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">pha</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">def</span> <span class="nf">_makeHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">,</span> <span class="n">reqZeros</span><span class="p">):</span>
        <span class="n">fomatstr</span> <span class="o">=</span> <span class="s1">&#39;{:0&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reqZeros</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;d}&#39;</span>
        <span class="c1"># assume cross corr and cat origins are identical</span>
        <span class="n">head</span> <span class="o">=</span> <span class="s1">&#39;# &#39;</span> <span class="o">+</span> <span class="n">fomatstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num1</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fomatstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;0.0&#39;</span>
        <span class="k">return</span> <span class="n">head</span>

    <span class="k">def</span> <span class="nf">_makeCodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">evcodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">evcodes</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">NAME</span>
        <span class="k">return</span> <span class="n">evcodes</span>

<div class="viewcode-block" id="ClusterStream.updateReqCC"><a class="viewcode-back" href="../../detex.html#detex.subspace.ClusterStream.updateReqCC">[docs]</a>    <span class="k">def</span> <span class="nf">updateReqCC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reqCC</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the required correlation coefficient for clusters to form on</span>
<span class="sd">        all stations or individual stations. </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------------</span>
<span class="sd">        reqCC : float (between 0 and 1), or dict of reference keys and floats</span>
<span class="sd">            if reqCC is a float the required correlation coeficient for </span>
<span class="sd">            clusters to form will be set to reqCC on all stations. </span>
<span class="sd">            If dict keys must be indicies for each cluster object (IE net.sta,</span>
<span class="sd">            sta, or int index) and values are the reqCC for that station.</span>
<span class="sd">        Notes </span>
<span class="sd">        ---------------</span>
<span class="sd">        The Cluster class also have a similar method that can be more </span>
<span class="sd">        intuitive to use, as in the tutorial</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reqCC</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reqCC</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">reqCC</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;reqCC must be between 0 and 1&#39;</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">updateReqCC</span><span class="p">(</span><span class="n">reqCC</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reqCC</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">reqCC</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">updateReqCC</span><span class="p">(</span><span class="n">reqCC</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reqCC</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reqCC</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">updateReqCC</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterStream.printAtr"><a class="viewcode-back" href="../../detex.html#detex.subspace.ClusterStream.printAtr">[docs]</a>    <span class="k">def</span> <span class="nf">printAtr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># print out basic attributes used to make cluster</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">printAtr</span><span class="p">()</span></div>

<div class="viewcode-block" id="ClusterStream.dendro"><a class="viewcode-back" href="../../detex.html#detex.subspace.ClusterStream.dendro">[docs]</a>    <span class="k">def</span> <span class="nf">dendro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create dendrograms for each station</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">dendro</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterStream.simMatrix"><a class="viewcode-back" href="../../detex.html#detex.subspace.ClusterStream.simMatrix">[docs]</a>    <span class="k">def</span> <span class="nf">simMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupClusts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">savename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnMat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to create similarity matrix of each event pair</span>

<span class="sd">        Parameters</span>
<span class="sd">        -------</span>
<span class="sd">        groupClusts : bool</span>
<span class="sd">            If True order by clusters on the simmatrix with the singletons </span>
<span class="sd">            coming last</span>
<span class="sd">        savename : str or False</span>
<span class="sd">            If not False, a path used by plt.savefig to save the current </span>
<span class="sd">            figure. The extension is necesary for specifying format. </span>
<span class="sd">            See plt.savefig for details</span>
<span class="sd">        returnMat : bool</span>
<span class="sd">            If true return the similarity matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
            <span class="n">dout</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">simMatrix</span><span class="p">(</span><span class="n">groupClusts</span><span class="p">,</span> <span class="n">savename</span><span class="p">,</span> <span class="n">returnMat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dout</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterStream.plotEvents"><a class="viewcode-back" href="../../detex.html#detex.subspace.ClusterStream.plotEvents">[docs]</a>    <span class="k">def</span> <span class="nf">plotEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;merc&#39;</span><span class="p">,</span> <span class="n">plotSingles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the event locations for each station using basemap. Calls the </span>
<span class="sd">        plotEvents method of the Cluster class, see its docs for accepted </span>
<span class="sd">        kwargs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        projection : str</span>
<span class="sd">            The pojection type to pass to basemap</span>
<span class="sd">        plotSingles : bool</span>
<span class="sd">            If True also plot the singletons (events that dont cluster)</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -------</span>
<span class="sd">        </span>
<span class="sd">        kwargs are passed to basemap</span>
<span class="sd">        </span>
<span class="sd">        If no working installation of basemap is found an ImportError will </span>
<span class="sd">        be raised. See the following URL for tips on installing it:</span>
<span class="sd">        http://matplotlib.org/basemap/users/installing.html, good luck!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">plotEvents</span><span class="p">(</span><span class="n">projection</span><span class="p">,</span> <span class="n">plotSingles</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterStream.write"><a class="viewcode-back" href="../../detex.html#detex.subspace.ClusterStream.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># uses pickle to write class to disk</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write instance to file (name is the filename attribute)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;writing ClusterStream instance as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>  <span class="c1"># allows indexing of children Cluster objects</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stalist2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stalist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;indexer must either be an int or str of sta.net or sta&#39;</span>
                   <span class="s1">&#39; you passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">outstr</span> <span class="o">=</span> <span class="s1">&#39;SSClusterStream with </span><span class="si">%d</span><span class="s1"> stations &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stalist</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">outstr</span></div>


<div class="viewcode-block" id="Cluster"><a class="viewcode-back" href="../../detex.html#detex.subspace.Cluster">[docs]</a><span class="k">class</span> <span class="nc">Cluster</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clustStream</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">temkey</span><span class="p">,</span> <span class="n">eventList</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ccReq</span><span class="p">,</span>
                 <span class="n">filt</span><span class="p">,</span> <span class="n">decimate</span><span class="p">,</span> <span class="n">trim</span><span class="p">,</span> <span class="n">DFcc</span><span class="p">):</span>

        <span class="c1"># instantiate a few needed varaibles (not all to save space)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">link</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DFcc</span> <span class="o">=</span> <span class="n">DFcc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span> <span class="o">=</span> <span class="n">temkey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">eventList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateReqCC</span><span class="p">(</span><span class="n">ccReq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trim</span> <span class="o">=</span> <span class="n">trim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decimate</span> <span class="o">=</span> <span class="n">decimate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonClustColor</span> <span class="o">=</span> <span class="s1">&#39;0.6&#39;</span>  <span class="c1"># use a grey of 0.6 for singletons</span>

<div class="viewcode-block" id="Cluster.updateReqCC"><a class="viewcode-back" href="../../detex.html#detex.subspace.Cluster.updateReqCC">[docs]</a>    <span class="k">def</span> <span class="nf">updateReqCC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newccReq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to update the required correlation coeficient for </span>
<span class="sd">        this station</span>
<span class="sd">        Parameters</span>
<span class="sd">        -------------</span>
<span class="sd">        newccReq : float (between 0 and 1)</span>
<span class="sd">            Required correlation coef</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">newccReq</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">newccReq</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Parameter ccReq must be between 0 and 1&#39;</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccReq</span> <span class="o">=</span> <span class="n">newccReq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dflink</span><span class="p">,</span> <span class="n">serclus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeDFLINK</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># get events that actually cluster (filter out singletons)</span>
        <span class="n">dfcl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dflink</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dflink</span><span class="o">.</span><span class="n">disSim</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccReq</span><span class="p">]</span>
        <span class="c1"># sort putting highest links in cluster on top</span>
        <span class="n">dfcl</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;disSim&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dfcl</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dftemp</span> <span class="o">=</span> <span class="n">dfcl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">clustlinks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">clustEvents</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">clnum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">dftemp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ser</span> <span class="o">=</span> <span class="n">dftemp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ndf</span> <span class="o">=</span> <span class="n">dftemp</span><span class="p">[[</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">II</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dftemp</span><span class="o">.</span><span class="n">II</span><span class="p">]]</span>
            <span class="n">clustlinks</span><span class="p">[</span><span class="n">clnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndf</span><span class="o">.</span><span class="n">clust</span>
            <span class="n">valset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ndf</span><span class="o">.</span><span class="n">II</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
            <span class="n">clustEvents</span><span class="p">[</span><span class="n">clnum</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">valset</span><span class="p">)</span>
            <span class="n">dftemp</span> <span class="o">=</span> <span class="n">dftemp</span><span class="p">[</span><span class="o">~</span><span class="n">dftemp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ndf</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
            <span class="n">clnum</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clustlinks</span> <span class="o">=</span> <span class="n">clustlinks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusts</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">clustEvents</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
                       <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clustEvents</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">keyset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="n">clustset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusts</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">singles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keyset</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">clustset</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clustcount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clustColors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getColors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ccReq for station </span><span class="si">%s</span><span class="s1"> updated to ccReq=</span><span class="si">%1.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">newccReq</span><span class="p">))</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_getColors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numClusts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See if there are enough defualt colors for the clusters, if not</span>
<span class="sd">        Generate N unique colors (that probably dont look good together)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clustColorsDefault</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">]</span>
        <span class="c1"># if there are enough default python colors use them</span>
        <span class="k">if</span> <span class="n">numClusts</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clustColorsDefault</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">clustColorsDefault</span><span class="p">[:</span><span class="n">numClusts</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if not generaete N unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">360.</span><span class="p">,</span> <span class="mf">360.</span> <span class="o">/</span> <span class="n">numClusts</span><span class="p">):</span>
                <span class="n">hue</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="mf">360.</span>
                <span class="n">lightness</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span>
                <span class="n">saturation</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span>
                <span class="n">cvect</span> <span class="o">=</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hls_to_rgb</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">lightness</span><span class="p">,</span> <span class="n">saturation</span><span class="p">)</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cvect</span><span class="p">]</span>
                <span class="c1"># covnert to hex code</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;BBB&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">rgb</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">colors</span>

    <span class="k">def</span> <span class="nf">_makeColorDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clustColors</span><span class="p">,</span> <span class="n">nonClustColor</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">colorsequence</span> <span class="o">=</span> <span class="n">clustColors</span>
        <span class="c1"># if not enough colors repeat color matrix</span>
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clustColors</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">colorsequence</span> <span class="o">=</span> <span class="n">clustColors</span> <span class="o">*</span> \
                            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">clustColors</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colorsequence</span> <span class="o">=</span> <span class="n">clustColors</span>
        <span class="c1"># unitialize color list with default color</span>
        <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">nonClustColor</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dflink</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustlinks</span><span class="p">[</span><span class="n">a</span><span class="p">]:</span>
                <span class="n">color_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="n">colorsequence</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">color_list</span>

    <span class="k">def</span> <span class="nf">_makeDFLINK</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># make the link dataframe</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>
        <span class="c1"># append cluster numbers to link array</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">truncate</span><span class="p">:</span>  <span class="c1"># truncate after required coeficient</span>
            <span class="n">linkup</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="n">link</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccReq</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">linkup</span> <span class="o">=</span> <span class="n">link</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">fcluster</span><span class="p">(</span><span class="n">link</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccReq</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
        <span class="n">serclus</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

        <span class="n">clusdict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">linkup</span><span class="p">)):</span>
            <span class="n">clusdict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">linkup</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">4</span><span class="p">])]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">clusdict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">linkup</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">])],</span> <span class="n">clusdict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">linkup</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">])])</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">,</span> <span class="s1">&#39;disSim&#39;</span><span class="p">,</span> <span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="s1">&#39;clust&#39;</span><span class="p">]</span>
        <span class="n">dflink</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">linkup</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dflink</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dflink</span><span class="p">[</span><span class="s1">&#39;II&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No events cluster with corr coef = </span><span class="si">%1.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccReq</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dflink</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  <span class="c1"># enumerate cluster contents</span>
            <span class="n">ar1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clusdict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">i1</span><span class="p">)]))</span>
            <span class="n">ar2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clusdict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">i2</span><span class="p">)]))</span>
            <span class="n">dflink</span><span class="p">[</span><span class="s1">&#39;II&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ar1</span> <span class="o">+</span> <span class="n">ar2</span>
        <span class="k">return</span> <span class="n">dflink</span><span class="p">,</span> <span class="n">serclus</span>

    <span class="c1"># creates a basic dendrogram plot</span>
<div class="viewcode-block" id="Cluster.dendro"><a class="viewcode-back" href="../../detex.html#detex.subspace.Cluster.dendro">[docs]</a>    <span class="k">def</span> <span class="nf">dendro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hideEventLabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">saveName</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to plot dendrograms of the clusters</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----</span>
<span class="sd">        hideEventLabels : bool</span>
<span class="sd">            turns x axis labeling on/off. Better set to false </span>
<span class="sd">            if many events are in event pool</span>
<span class="sd">        show : bool</span>
<span class="sd">            If true call plt.show</span>
<span class="sd">        saveName : str or False</span>
<span class="sd">            path to save figure. Extention denotes format. See plt.savefig </span>
<span class="sd">            for details</span>
<span class="sd">        legend : bool</span>
<span class="sd">            If true plot a legend on the side of the dendrogram</span>
<span class="sd">        Note </span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs are passed to scipy.cluster.hierarchy.dendrogram, see docs</span>
<span class="sd">        for acceptable arguments and descriptions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get color schemes</span>
        <span class="n">color_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeColorDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustColors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonClustColor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">)):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clustColors</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonClustColor</span><span class="p">)</span>
        <span class="n">dendrogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">,</span> <span class="n">color_threshold</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccReq</span><span class="p">,</span> <span class="n">count_sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">link_color_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">color_list</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">box</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span>
                      <span class="p">[</span><span class="s1">&#39;N/A&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">),</span>
                      <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Clusters&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">hideEventLabels</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Events&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Dissimilarity&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">saveName</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveName</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Cluster.plotEvents"><a class="viewcode-back" href="../../detex.html#detex.subspace.Cluster.plotEvents">[docs]</a>    <span class="k">def</span> <span class="nf">plotEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;merc&#39;</span><span class="p">,</span> <span class="n">plotSingles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the event locations for each station using basemap. Calls the </span>
<span class="sd">        plotEvents method of the Cluster class, see its docs for accepted </span>
<span class="sd">        kwargs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        projection : str</span>
<span class="sd">            The pojection type to pass to basemap</span>
<span class="sd">        plotSingles : bool</span>
<span class="sd">            If True also plot the singletons (events that dont cluster)</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -------</span>
<span class="sd">        kwargs are passed to basemap</span>
<span class="sd">        If no working installation of basemap is found an ImportError will </span>
<span class="sd">        be raised. See the following URL for tips on installing it:</span>
<span class="sd">        http://matplotlib.org/basemap/users/installing.html, good luck!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO make dot size scale with magnitudes</span>
        <span class="c1"># make sure basemap is installed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="k">import</span> <span class="n">Basemap</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;mpl_toolskits basemap not installed, cant plot&#39;</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="ne">ImportError</span><span class="p">)</span>
        <span class="c1"># init figures and get limits</span>
        <span class="n">fig_map</span><span class="p">,</span> <span class="n">emap</span><span class="p">,</span> <span class="n">horrange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_map</span><span class="p">(</span><span class="n">Basemap</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">zscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_z_scaling</span><span class="p">(</span><span class="n">horrange</span><span class="p">)</span>
        <span class="n">fig_lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_profile_figs</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">zscale</span><span class="p">)</span>
        <span class="n">fig_lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_profile_figs</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">zscale</span><span class="p">)</span>
        <span class="c1"># seperate singletons from clustered events</span>
        <span class="n">cl_dfs</span><span class="p">,</span> <span class="n">sing_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_singletons_and_clusters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_map_view</span><span class="p">(</span><span class="n">emap</span><span class="p">,</span> <span class="n">fig_map</span><span class="p">,</span> <span class="n">horrange</span><span class="p">,</span> <span class="n">cl_dfs</span><span class="p">,</span> <span class="n">sing_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_profile_view</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">zscale</span><span class="p">,</span> <span class="n">fig_lat</span><span class="p">,</span> <span class="n">fig_lon</span><span class="p">,</span> <span class="n">cl_dfs</span><span class="p">,</span>
                                <span class="n">sing_df</span><span class="p">,</span> <span class="n">emap</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Basemap</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to setup the map figure with basemap returns the </span>
<span class="sd">        figure instance and basemap instance and horizontal range of plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">map_fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="c1"># get map bounds       </span>
        <span class="n">latmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">LAT</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">latmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">LAT</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lonmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">LON</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">lonmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">LON</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1"># create buffers so there is a slight border with no events around map</span>
        <span class="n">latbuff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">latmax</span> <span class="o">-</span> <span class="n">latmin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">lonbuff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">lonmax</span> <span class="o">-</span> <span class="n">lonmin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># get the total horizontal distance of plot in km</span>
        <span class="n">totalxdist</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">geodetics</span><span class="o">.</span><span class="n">gps2DistAzimuth</span><span class="p">(</span>
            <span class="n">latmin</span><span class="p">,</span> <span class="n">lonmin</span><span class="p">,</span> <span class="n">latmin</span><span class="p">,</span> <span class="n">lonmax</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="c1"># init projection</span>
        <span class="n">emap</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
                       <span class="n">lat_0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">latmin</span><span class="p">,</span> <span class="n">latmax</span><span class="p">]),</span>
                       <span class="n">lon_0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">lonmin</span><span class="p">,</span> <span class="n">lonmax</span><span class="p">]),</span>
                       <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
                       <span class="n">area_thresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                       <span class="n">llcrnrlon</span><span class="o">=</span><span class="n">lonmin</span> <span class="o">-</span> <span class="n">lonbuff</span><span class="p">,</span>
                       <span class="n">llcrnrlat</span><span class="o">=</span><span class="n">latmin</span> <span class="o">-</span> <span class="n">latbuff</span><span class="p">,</span>
                       <span class="n">urcrnrlon</span><span class="o">=</span><span class="n">lonmax</span> <span class="o">+</span> <span class="n">lonbuff</span><span class="p">,</span>
                       <span class="n">urcrnrlat</span><span class="o">=</span><span class="n">latmax</span> <span class="o">+</span> <span class="n">latbuff</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># draw scale</span>
        <span class="n">emap</span><span class="o">.</span><span class="n">drawmapscale</span><span class="p">(</span><span class="n">lonmin</span><span class="p">,</span> <span class="n">latmin</span><span class="p">,</span> <span class="n">lonmin</span><span class="p">,</span> <span class="n">latmin</span><span class="p">,</span> <span class="n">totalxdist</span> <span class="o">/</span> <span class="mf">4.5</span><span class="p">)</span>

        <span class="c1"># get limits in projection</span>
        <span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">emap</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="n">emap</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">emap</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span> <span class="n">emap</span><span class="o">.</span><span class="n">ymin</span>
        <span class="n">horrange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">),</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">))</span>  <span class="c1"># horizontal range</span>

        <span class="c1"># get maximum degree distance for setting scalable ticks</span>
        <span class="n">latdi</span><span class="p">,</span> <span class="n">londi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">latmax</span> <span class="o">-</span> <span class="n">latmin</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lonmax</span> <span class="o">-</span> <span class="n">lonmin</span><span class="p">)]</span>
        <span class="n">maxdeg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">latdi</span><span class="p">,</span> <span class="n">londi</span><span class="p">)</span>
        <span class="n">parallels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">maxdeg</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">emap</span><span class="o">.</span><span class="n">drawparallels</span><span class="p">(</span><span class="n">parallels</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">meridians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">360.</span><span class="p">,</span> <span class="n">maxdeg</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">mers</span> <span class="o">=</span> <span class="n">emap</span><span class="o">.</span><span class="n">drawmeridians</span><span class="p">(</span><span class="n">meridians</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mers</span><span class="p">:</span>  <span class="c1"># rotate meridian labels</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mers</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Clusters on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">map_fig</span><span class="p">,</span> <span class="n">emap</span><span class="p">,</span> <span class="n">horrange</span>

    <span class="k">def</span> <span class="nf">_init_profile_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">zscale</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        init figs for plotting the profiles of the events</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># init profile figures</span>
        <span class="n">profile_fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">zmin</span> <span class="o">*</span> <span class="n">zscale</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">zmax</span> <span class="o">*</span> <span class="n">zscale</span>
        <span class="n">tickfor</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%0.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x1</span> <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">tickfor</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Depth (km)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">profile_fig</span>

    <span class="k">def</span> <span class="nf">_get_z_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">horrange</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return z limits and scale factors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">DEPTH</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">DEPTH</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">zscale</span> <span class="o">=</span> <span class="n">horrange</span> <span class="o">/</span> <span class="p">(</span><span class="n">zmax</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">zscale</span>

    <span class="k">def</span> <span class="nf">_get_singletons_and_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;        </span>
<span class="sd">        get dataframes of clustered events and singletons</span>
<span class="sd">        Note: cl_dfs is a list of dfs whereas sing_df is just a df</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cl_dfs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">NAME</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">]</span>
        <span class="n">sing_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">NAME</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">cl_dfs</span><span class="p">,</span> <span class="n">sing_df</span>

    <span class="k">def</span> <span class="nf">_plot_map_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emap</span><span class="p">,</span> <span class="n">map_fig</span><span class="p">,</span> <span class="n">horrange</span><span class="p">,</span> <span class="n">cl_dfs</span><span class="p">,</span> <span class="n">sing_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot the map figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">map_fig</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>  <span class="c1"># set to map figure</span>
        <span class="c1"># plot singles</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">emap</span><span class="p">(</span><span class="n">sing_df</span><span class="o">.</span><span class="n">LON</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sing_df</span><span class="o">.</span><span class="n">LAT</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">emap</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonClustColor</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">6.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">clnum</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cl_dfs</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">emap</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">LON</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">LAT</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">emap</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clustColors</span><span class="p">[</span><span class="n">clnum</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_plot_profile_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">zscale</span><span class="p">,</span> <span class="n">fig_lat</span><span class="p">,</span> <span class="n">fig_lon</span><span class="p">,</span> <span class="n">cl_df</span><span class="p">,</span>
                           <span class="n">sing_df</span><span class="p">,</span> <span class="n">emap</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot the profile view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_sing</span><span class="p">,</span> <span class="n">y_sing</span> <span class="o">=</span> <span class="n">emap</span><span class="p">(</span><span class="n">sing_df</span><span class="o">.</span><span class="n">LON</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sing_df</span><span class="o">.</span><span class="n">LAT</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="c1"># plot singletons</span>
        <span class="n">nccolor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonClustColor</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig_lon</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_sing</span><span class="p">,</span> <span class="n">sing_df</span><span class="o">.</span><span class="n">DEPTH</span> <span class="o">*</span> <span class="n">zscale</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">nccolor</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">6.0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig_lat</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_sing</span><span class="p">,</span> <span class="n">sing_df</span><span class="o">.</span><span class="n">DEPTH</span> <span class="o">*</span> <span class="n">zscale</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">nccolor</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">6.0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
        <span class="c1"># plot clusters</span>
        <span class="k">for</span> <span class="n">clnum</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cl_df</span><span class="p">):</span>
            <span class="n">ccolor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustColors</span><span class="p">[</span><span class="n">clnum</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">emap</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">LON</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">LAT</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig_lon</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">DEPTH</span> <span class="o">*</span> <span class="n">zscale</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">ccolor</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig_lat</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">DEPTH</span> <span class="o">*</span> <span class="n">zscale</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">ccolor</span><span class="p">)</span>
        <span class="c1"># set buffers so nothing plots right on edge</span>
        <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fig_lat</span><span class="p">,</span> <span class="n">fig_lon</span><span class="p">]:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
            <span class="n">xdist</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">xlim</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xdist</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xdist</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
            <span class="n">ydist</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">xlim</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ydist</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ydist</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Cluster.simMatrix"><a class="viewcode-back" href="../../detex.html#detex.subspace.Cluster.simMatrix">[docs]</a>    <span class="k">def</span> <span class="nf">simMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupClusts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">savename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnMat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to create basic similarity matrix of the values </span>
<span class="sd">        in the cluster object</span>

<span class="sd">        Parameters</span>
<span class="sd">        -------</span>
<span class="sd">        groupClusts : boolean</span>
<span class="sd">            If True order by clusters on the simmatrix with the </span>
<span class="sd">            singletons coming last</span>
<span class="sd">        savename : str or False</span>
<span class="sd">            If not False, a path used by plt.savefig to save the current </span>
<span class="sd">            figure. The extension is necesary for specifying format. See </span>
<span class="sd">            plt.savefig for details</span>
<span class="sd">        returnMat : boolean</span>
<span class="sd">            If true return the similarity matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">groupClusts</span><span class="p">:</span>  <span class="c1"># if grouping clusters together</span>
            <span class="n">clusts</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">)</span>  <span class="c1"># get cluster list</span>
            <span class="n">clusts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">)</span>  <span class="c1"># add singles list at end</span>
            <span class="n">eveOrder</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">clusts</span><span class="p">))</span>
            <span class="n">indmask</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">num</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">eve</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span><span class="p">,</span>
                                                   <span class="n">eve</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eveOrder</span><span class="p">)}</span>  <span class="c1"># create a mask forthe order</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># blank index mask if not</span>
            <span class="n">indmask</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">))}</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">le</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DFcc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">le</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">le</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># deb([le,indmask,self.DFcc])</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">le</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">le</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
                    <span class="n">mat</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># new a and b coords based on mask</span>
                    <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">indmask</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">indmask</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
                    <span class="n">gi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>
                    <span class="n">li</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>
                    <span class="n">mat</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DFcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">,</span> <span class="n">gi</span><span class="p">]</span>
                    <span class="n">mat</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DFcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">,</span> <span class="n">gi</span><span class="p">]</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span>
            <span class="s1">&#39;my_colormap&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">],</span> <span class="mi">256</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">mat</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savename</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">returnMat</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mat</span></div>

<div class="viewcode-block" id="Cluster.write"><a class="viewcode-back" href="../../detex.html#detex.subspace.Cluster.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># uses pickle to write class to disk</span>
        <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Cluster.printAtr"><a class="viewcode-back" href="../../detex.html#detex.subspace.Cluster.printAtr">[docs]</a>    <span class="k">def</span> <span class="nf">printAtr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># print out basic attributes used to make cluster</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Cluster&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> Events cluster out of </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustcount</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustcount</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total number of clusters = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Required Cross Correlation Coeficient = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccReq</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>  <span class="c1"># allow indexing</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># make class iterable</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusts</span><span class="p">)</span></div>


<span class="c1"># def __repr__(self):</span>
<span class="c1">#        self.printAtr()</span>
<span class="c1">#        return &#39;&#39;</span>


<div class="viewcode-block" id="SubSpace"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace">[docs]</a><span class="k">class</span> <span class="nc">SubSpace</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class used to hold subspaces for detector</span>
<span class="sd">    Holds both subspaces (as defined from the SScluster object) and </span>
<span class="sd">    single event clusters, or singles</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">singlesDict</span><span class="p">,</span> <span class="n">subSpaceDict</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">Pf</span><span class="p">,</span> <span class="n">cfetcher</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfetcher</span> <span class="o">=</span> <span class="n">cfetcher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">cl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span> <span class="o">=</span> <span class="n">subSpaceDict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">singles</span> <span class="o">=</span> <span class="n">singlesDict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">singletons</span> <span class="o">=</span> <span class="n">singlesDict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pf</span> <span class="o">=</span> <span class="n">Pf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">singStations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Stations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singStations</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Stations</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stakey2</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stakey1</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">}</span>

    <span class="c1">################################ Validate Cluster functions</span>

<div class="viewcode-block" id="SubSpace.validateClusters"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.validateClusters">[docs]</a>    <span class="k">def</span> <span class="nf">validateClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to check for misaligned waveforms and discard those that no </span>
<span class="sd">        longer meet the required correlation coeficient for each cluster. </span>
<span class="sd">        See Issue 25 (www.github.com/d-chambers/detex) for why this might </span>
<span class="sd">        be useful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Validating aligned (and trimmed) waveforms in each cluster&#39;</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span>
            <span class="n">ccreq</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">ccReq</span>
            <span class="k">for</span> <span class="n">clustNum</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">subs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">stKeys</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="c1"># get trim times if defined</span>
                <span class="k">if</span> <span class="s1">&#39;Starttime&#39;</span> <span class="ow">in</span> <span class="n">stKeys</span> <span class="ow">and</span> <span class="s1">&#39;Endtime&#39;</span> <span class="ow">in</span> <span class="n">stKeys</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Starttime&#39;</span><span class="p">]</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Endtime&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">ev1num</span><span class="p">,</span> <span class="n">ev1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">ccs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># blank list for storing ccs of aligned WFs</span>
                    <span class="k">for</span> <span class="n">ev2</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">[</span><span class="n">ev1num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]:</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">AlignedTD</span><span class="p">[</span><span class="n">ev1</span><span class="p">][</span><span class="n">start</span><span class="p">:</span> <span class="n">stop</span><span class="p">]</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">AlignedTD</span><span class="p">[</span><span class="n">ev2</span><span class="p">][</span><span class="n">start</span><span class="p">:</span> <span class="n">stop</span><span class="p">]</span>
                        <span class="n">maxcc</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">construct</span><span class="o">.</span><span class="n">fast_normcorr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                        <span class="n">ccs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxcc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">ccs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ccreq</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> fails validation check or is ill-aligned &#39;</span>
                                <span class="s1">&#39;on station </span><span class="si">%s</span><span class="s1">, removing&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">ev1</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">))</span>
                        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_removeEvent</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">ev1</span><span class="p">,</span> <span class="n">clustNum</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Finished validateCluster call&#39;</span>
        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_removeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">clustNum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to remove an event from a SubSpace instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># remove from eventList</span>
        <span class="n">srow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">clustNum</span><span class="p">]</span>
        <span class="n">srow</span><span class="o">.</span><span class="n">Events</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">srow</span><span class="o">.</span><span class="n">AlignedTD</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1">################################ SVD Functions</span>

<div class="viewcode-block" id="SubSpace.SVD"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.SVD">[docs]</a>    <span class="k">def</span> <span class="nf">SVD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectCriteria</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">selectValue</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">conDatNum</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useSingles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">validateWaveforms</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backupThreshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to perform SVD on the alligned waveforms and select which </span>
<span class="sd">        of the SVD basis are to be used in event detection. Also assigns </span>
<span class="sd">        a detection threshold to each subspace-station pair.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------------</span>

<span class="sd">        selctionCriteria : int, selectValue : number</span>
<span class="sd">            selectCriteria is the method for selecting which basis vectors </span>
<span class="sd">            will be used as detectors. selectValue depends on selectCriteria</span>
<span class="sd">            Valid options are:</span>

<span class="sd">            0 - using the given Pf, find number of dimensions to maximize </span>
<span class="sd">            detection probability !!! NOT YET IMPLIMENTED!!!</span>
<span class="sd">                    selectValue - Not used</span>
<span class="sd">                    (Need to find a way to use the doubly-non central F </span>
<span class="sd">                    distribution in python)</span>

<span class="sd">            1 - Failed implementation, not supported</span>

<span class="sd">            2 - select basis number based on an average fractional signal </span>
<span class="sd">            energy captured (see Figure 8 of Harris 2006). Then calculate</span>
<span class="sd">            an empirical distribution of the detection statistic by running</span>
<span class="sd">            each subspace over random continuous data with no high amplitude</span>
<span class="sd">            signals (see getFAS method). A beta distribution is then fit to</span>
<span class="sd">            the data and the DS value that sets the probability of false </span>
<span class="sd">            detection to the Pf defined in the subspace instance is selected</span>
<span class="sd">            as the threshold.            </span>
<span class="sd">                    selectValue - Average fractional energy captured, </span>
<span class="sd">                    can range from 0 (use no basis vectors) to 1</span>
<span class="sd">                    (use all basis vectors). A value between 0.75 and 0.95</span>
<span class="sd">                    is recommended. </span>
<span class="sd">                    </span>
<span class="sd">            3 - select basis number based on an average fractional signal </span>
<span class="sd">            energy captured (see Figure 8 of Harris 2006).</span>
<span class="sd">            Then set detection threshold to a percentage of the minimum </span>
<span class="sd">            fractional energy captured. This method is a bit quick and dirty</span>
<span class="sd">            but ensures all events in the waveform pool will be detected.</span>
<span class="sd">                select value is a fraction representing the fraction of </span>
<span class="sd">                the minum fractional energy captured (between 0 and 1).</span>

<span class="sd">            4 - use a user defined number of basis vectors, beginning with the </span>
<span class="sd">            most significant (Barrett and Beroza 2014 use first two basis</span>
<span class="sd">            vectors as an &quot;empirical&quot; subspace detector). Then use the same </span>
<span class="sd">            technique in method one to set threshold</span>
<span class="sd">                    selectValue - can range from 0 to number of events in </span>
<span class="sd">                    subspace, if selectValue is greater than number of events </span>
<span class="sd">                    all events are used</span>

<span class="sd">        conDatNum : int</span>
<span class="sd">            The number of continuous data chunks to use to estimate the </span>
<span class="sd">            effective dimension of the signal space or to estimate the null</span>
<span class="sd">            distribution. Used if selectCriteria == 1,2,4</span>
<span class="sd">        threshold : float or None</span>
<span class="sd">            Used to set each subspace at a user defined threshold. If any </span>
<span class="sd">            value is set it overrides any of the previously defined methods and</span>
<span class="sd">            avoids estimating the effective dimension of representation or </span>
<span class="sd">            distribution of the null space. Can be useful if problems arise</span>
<span class="sd">            in the false alarm statistic calculation</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            If true normalize the amplitude of all the training events before </span>
<span class="sd">            preforming the SVD. Keeps higher amplitude events from dominating</span>
<span class="sd">            the SVD vectors but can over emphasize noise. Haris 2006 recomends</span>
<span class="sd">            using normalization but the personal experience of the author has</span>
<span class="sd">            found normalization can increase the detector&#39;s propensity to </span>
<span class="sd">            return false detections.</span>
<span class="sd">        useSingles : bool</span>
<span class="sd">            If True also calculate the thresholds for singles</span>
<span class="sd">        validateWaveforms : bool</span>
<span class="sd">            If True call the validateClusters method before the performing SVD</span>
<span class="sd">            to make sure each trimed aligned waveform still meets the</span>
<span class="sd">            required correlation coeficient. Any waveforms that do not will</span>
<span class="sd">            be discarded. </span>
<span class="sd">        backupThreshold : None or float</span>
<span class="sd">            A backup threshold to use if approximation fails. Typically,</span>
<span class="sd">            using the default detex settings, a reasonable value would be</span>
<span class="sd">            0.25</span>
<span class="sd">            </span>
<span class="sd">        kwargs are passed to the getFAS call (if used)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># make sure user defined options are kosher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkSelection</span><span class="p">(</span><span class="n">selectCriteria</span><span class="p">,</span> <span class="n">selectValue</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="c1"># Iterate through all subspaces defined by stations</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">UsedSVDKeys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">svdDict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># initialize dict to put SVD vectors in</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">)</span>
                <span class="n">arr</span><span class="p">,</span> <span class="n">basisLength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trimGroups</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">station</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">basisLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;subspace </span><span class="si">%d</span><span class="s1"> on </span><span class="si">%s</span><span class="s1"> is failing alignment and &#39;</span>
                            <span class="s1">&#39;trimming, deleting it&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">station</span><span class="p">))</span>
                    <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_drop_subspace</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">])</span>
                <span class="n">tparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
                <span class="c1"># perform SVD</span>
                <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vh</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">tparr</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># make dict with sing. value as key and sing. vector as value</span>
                <span class="k">for</span> <span class="n">einum</span><span class="p">,</span> <span class="n">eival</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                    <span class="n">svdDict</span><span class="p">[</span><span class="n">eival</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span> <span class="n">einum</span><span class="p">]</span>
                <span class="c1"># asign Parameters back to subspace dataframes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">SVD</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">svdDict</span>  <span class="c1"># assign SVD</span>
                <span class="n">fracEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFracEnergy</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">svdDict</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>

                <span class="n">usedBasis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getUsedBasis</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">svdDict</span><span class="p">,</span> <span class="n">fracEnergy</span><span class="p">,</span>
                                               <span class="n">selectCriteria</span><span class="p">,</span> <span class="n">selectValue</span><span class="p">)</span>
                <span class="c1"># Add fracEnergy and SVD keys (sing. vals) to main DataFrames</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">FracEnergy</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">fracEnergy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">UsedSVDKeys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">usedBasis</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">SVDdefined</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">numBas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">UsedSVDKeys</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">NumBasis</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">numBas</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setThresholds</span><span class="p">(</span><span class="n">selectCriteria</span><span class="p">,</span> <span class="n">selectValue</span><span class="p">,</span> <span class="n">conDatNum</span><span class="p">,</span>
                                <span class="n">threshold</span><span class="p">,</span> <span class="n">basisLength</span><span class="p">,</span> <span class="n">backupThreshold</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singStations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">useSingles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setSinglesThresholds</span><span class="p">(</span><span class="n">conDatNum</span><span class="o">=</span><span class="n">conDatNum</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                                      <span class="n">backupThreshold</span><span class="o">=</span><span class="n">backupThreshold</span><span class="p">,</span>
                                      <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_drop_subspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">ssnum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drop a subspace that is misbehaving</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span> <span class="o">=</span> <span class="n">space</span><span class="p">[</span><span class="n">space</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ssnum</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_trimGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">station</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to get trimed subspaces if trim times are defined, and </span>
<span class="sd">        return an array of the aligned waveforms for the SVD to act on</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stkeys</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">aliTD</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">AlignedTD</span>
        <span class="k">if</span> <span class="s1">&#39;Starttime&#39;</span> <span class="ow">in</span> <span class="n">stkeys</span> <span class="ow">and</span> <span class="s1">&#39;Endtime&#39;</span> <span class="ow">in</span> <span class="n">stkeys</span><span class="p">:</span>
            <span class="n">stim</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Starttime&#39;</span><span class="p">]</span>
            <span class="n">etim</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Endtime&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">stim</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># make sure stim is not less than 0</span>
                <span class="n">stim</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">aliTD</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">stim</span><span class="p">:</span><span class="n">etim</span><span class="p">]</span> <span class="o">-</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aliTD</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">stim</span><span class="p">:</span><span class="n">etim</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>
            <span class="n">basisLength</span> <span class="o">=</span> <span class="n">Arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;No trim times for </span><span class="si">%s</span><span class="s1"> and station </span><span class="si">%s</span><span class="s1">, try running &#39;</span>
                   <span class="s1">&#39;pickTimes or attachPickTimes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">station</span><span class="p">))</span>

            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">aliTD</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aliTD</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>
            <span class="n">basisLength</span> <span class="o">=</span> <span class="n">Arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Arr</span><span class="p">,</span> <span class="n">basisLength</span>

    <span class="k">def</span> <span class="nf">_checkSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectCriteria</span><span class="p">,</span> <span class="n">selectValue</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure all user defined values are kosher for SVD call</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">selectCriteria</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">selectValue</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">selectValue</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;When selectCriteria==</span><span class="si">%d</span><span class="s1"> selectValue must be a float&#39;</span>
                       <span class="s1">&#39; between 0 and 1&#39;</span> <span class="o">%</span> <span class="n">selectCriteria</span><span class="p">)</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="ne">ValueError</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">selectCriteria</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">selectValue</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selectValue</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;When selectCriteria==3 selectValue must be an&#39;</span>
                       <span class="s1">&#39;integer greater than 0&#39;</span><span class="p">)</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="ne">ValueError</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;selectCriteria of </span><span class="si">%s</span><span class="s1"> is not supported&#39;</span> <span class="o">%</span> <span class="n">selectCriteria</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="ow">or</span> <span class="n">threshold</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Unsupported type for threshold, must be None or float&#39;</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="ne">ValueError</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getFracEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">svdDict</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculates the % energy capture for each stubspace for each possible</span>
<span class="sd">        dimension of rep. (up to # of events that go into the subspace)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fracDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Events</span>
        <span class="n">svales</span> <span class="o">=</span> <span class="n">svdDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">svales</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">stkeys</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>  <span class="c1"># dict defining sample trims</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">aliTD</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">AlignedTD</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># aligned waveform for event key</span>
            <span class="k">if</span> <span class="s1">&#39;Starttime&#39;</span> <span class="ow">in</span> <span class="n">stkeys</span> <span class="ow">and</span> <span class="s1">&#39;Endtime&#39;</span> <span class="ow">in</span> <span class="n">stkeys</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Starttime&#39;</span><span class="p">]</span>  <span class="c1"># start of trim in samps</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Endtime&#39;</span><span class="p">]</span>  <span class="c1"># end of trim in samps</span>
                <span class="n">aliwf</span> <span class="o">=</span> <span class="n">aliTD</span><span class="p">[</span><span class="n">start</span><span class="p">:</span> <span class="n">end</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aliwf</span> <span class="o">=</span> <span class="n">aliTD</span>
            <span class="n">Ut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>  <span class="c1"># transpose of basis vects</span>
            <span class="c1"># normalized dot product (mat. mult.) </span>
            <span class="n">normUtAliwf</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ut</span><span class="p">,</span> <span class="n">aliwf</span><span class="p">)</span> <span class="o">/</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">aliwf</span><span class="p">)</span>
            <span class="c1"># add 0% energy capture for dim of 0</span>
            <span class="n">repvect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">normUtAliwf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># cumul. energy captured for increasing dim. reps</span>
            <span class="n">cumrepvect</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">repvect</span><span class="p">[:</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">repvect</span><span class="p">))]</span>
            <span class="n">fracDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumrepvect</span>  <span class="c1"># add cumul. to keys</span>
        <span class="c1"># get average and min energy capture, append value to dict</span>
        <span class="n">fracDict</span><span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">fracDict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fracDict</span><span class="p">[</span><span class="s1">&#39;Minimum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">fracDict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">fracDict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getUsedBasis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">svdDict</span><span class="p">,</span> <span class="n">cumFracEnergy</span><span class="p">,</span>
                      <span class="n">selectCriteria</span><span class="p">,</span> <span class="n">selectValue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to populate  the keys of the selected SVD basis vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">svdDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selectCriteria</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="c1"># make sure last element is exactly 1</span>
            <span class="n">cumFracEnergy</span><span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.00</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cumFracEnergy</span><span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">selectValue</span><span class="p">)</span>
            <span class="n">selKeys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[:</span><span class="n">ndim</span><span class="p">]</span>  <span class="c1"># selected keys</span>
        <span class="k">if</span> <span class="n">selectCriteria</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">selKeys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[:</span><span class="n">selectValue</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">selKeys</span>

    <span class="k">def</span> <span class="nf">_setThresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectCriteria</span><span class="p">,</span> <span class="n">selectValue</span><span class="p">,</span> <span class="n">conDatNum</span><span class="p">,</span>
                       <span class="n">threshold</span><span class="p">,</span> <span class="n">basisLength</span><span class="p">,</span> <span class="n">backupThreshold</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">:</span>
                <span class="n">subspa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">subspa</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">Threshold</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold</span>

        <span class="k">elif</span> <span class="n">selectCriteria</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;selectCriteria 1 currently not supported&#39;</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="ne">ValueError</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">selectCriteria</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
            <span class="c1"># call getFAS to estimate null space dist.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getFAS</span><span class="p">(</span><span class="n">conDatNum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">:</span>
                <span class="n">subspa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">subspa</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">beta_a</span><span class="p">,</span> <span class="n">beta_b</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;betadist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># get threshold from beta dist. </span>
                    <span class="c1"># TODO consider implementing other dist. options as well</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">isf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Pf</span><span class="p">,</span> <span class="n">beta_a</span><span class="p">,</span> <span class="n">beta_b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">th</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
                        <span class="n">th</span><span class="p">,</span> <span class="n">Pftemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_approxThld</span><span class="p">(</span><span class="n">beta_a</span><span class="p">,</span> <span class="n">beta_b</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span>
                                                      <span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pf</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
                                                      <span class="n">backupThreshold</span><span class="p">)</span>

                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Scipy.stats.beta.isf failed with pf=</span><span class="si">%e</span><span class="s1">, &#39;</span>
                               <span class="s1">&#39;approximated threshold to </span><span class="si">%f</span><span class="s1"> with a Pf of </span><span class="si">%e</span><span class="s1"> &#39;</span>
                               <span class="s1">&#39;for station </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> using forward grid search&#39;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Pf</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">Pftemp</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">))</span>
                        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">Threshold</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">th</span>

        <span class="k">elif</span> <span class="n">selectCriteria</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">:</span>
                <span class="n">subspa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">subspa</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">FracEnergy</span><span class="p">[</span><span class="s1">&#39;Minimum&#39;</span><span class="p">][</span><span class="n">row</span><span class="o">.</span><span class="n">NumBasis</span><span class="p">]</span> <span class="o">*</span> <span class="n">selectValue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">Threshold</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">th</span>

<div class="viewcode-block" id="SubSpace.setSinglesThresholds"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.setSinglesThresholds">[docs]</a>    <span class="k">def</span> <span class="nf">setSinglesThresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conDatNum</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backupThreshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set thresholds for the singletons (unclustered events) by fitting </span>
<span class="sd">        a beta distribution to estimation of null space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        condatNum : int</span>
<span class="sd">            The number of continuous data chunks to use to fit PDF</span>
<span class="sd">        recalc : boolean</span>
<span class="sd">            If true recalculate the the False Alarm Statistics</span>
<span class="sd">        threshold : None or float between 0 and 1</span>
<span class="sd">            If number, don&#39;t call getFAS simply use given threshold</span>
<span class="sd">        backupThreshold : None or float</span>
<span class="sd">            If approximate a threshold fails then use backupThreshold. If None</span>
<span class="sd">            then raise. </span>
<span class="sd">        Note </span>
<span class="sd">        ----------</span>
<span class="sd">        Any singles without pick times will not be used. In this way singles </span>
<span class="sd">        can be rejected </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singStations</span><span class="p">:</span>
            <span class="n">sing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span>  <span class="c1"># singles on station</span>
            <span class="n">sampTrims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">SampleTrims</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">Name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SG</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sing</span><span class="p">))]</span>
            <span class="c1"># get singles that have phase picks</span>
            <span class="n">singsAccepted</span> <span class="o">=</span> <span class="n">sing</span><span class="p">[[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sampTrims</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span> <span class="o">=</span> <span class="n">singsAccepted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get empirical dist unless manual threshold is passed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getFAS</span><span class="p">(</span><span class="n">conDatNum</span><span class="p">,</span> <span class="n">useSingles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">useSubSpaces</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singStations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># skip singles with no pick times</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="n">threshold</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">beta_a</span><span class="p">,</span> <span class="n">beta_b</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;betadist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">isf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Pf</span><span class="p">,</span> <span class="n">beta_a</span><span class="p">,</span> <span class="n">beta_b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">th</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
                        <span class="n">th</span><span class="p">,</span> <span class="n">Pftemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_approxThld</span><span class="p">(</span><span class="n">beta_a</span><span class="p">,</span> <span class="n">beta_b</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
                                                      <span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pf</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
                                                      <span class="n">backupThreshold</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Scipy.stats.beta.isf failed with pf=</span><span class="si">%e</span><span class="s1">, &#39;</span>
                               <span class="s1">&#39;approximated threshold to </span><span class="si">%f</span><span class="s1"> with a Pf of </span><span class="si">%e</span><span class="s1"> &#39;</span>
                               <span class="s1">&#39;for station </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> using forward grid search&#39;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Pf</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">Pftemp</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">))</span>
                        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">][</span><span class="s1">&#39;Threshold&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">th</span></div>

    <span class="k">def</span> <span class="nf">_approxThld</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta_a</span><span class="p">,</span> <span class="n">beta_b</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">numint</span><span class="p">,</span> <span class="n">numloops</span><span class="p">,</span>
                    <span class="n">backupThreshold</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Because scipy.stats.beta.isf can break, if it returns a value near 1 </span>
<span class="sd">        when this is obviously wrong initialize grid search algorithm to get </span>
<span class="sd">        close to desired threshold using forward problem which seems to work</span>
<span class="sd">        where inverse fails See this bug report: </span>
<span class="sd">        https://github.com/scipy/scipy/issues/4677        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">startVal</span><span class="p">,</span> <span class="n">stopVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">loops</span> <span class="o">&lt;</span> <span class="n">numloops</span><span class="p">:</span>
            <span class="n">Xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">startVal</span><span class="p">,</span> <span class="n">stopVal</span><span class="p">,</span> <span class="n">numint</span><span class="p">)</span>
            <span class="n">pfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">beta_a</span><span class="p">,</span> <span class="n">beta_b</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Xs</span><span class="p">])</span>
            <span class="n">resids</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pfs</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">minind</span> <span class="o">=</span> <span class="n">resids</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">minind</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">minind</span> <span class="o">==</span> <span class="n">numint</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg1</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;Grid search for threshold failing for </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">, &#39;</span>
                         <span class="s1">&#39;set it manually or use default&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">msg2</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;Grid search for threshold failing for </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">, &#39;</span>
                         <span class="s1">&#39;using backup </span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">backupThreshold</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">backupThreshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="ne">ValueError</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg2</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">backupThreshold</span><span class="p">,</span> <span class="n">target</span>
            <span class="n">bestPf</span> <span class="o">=</span> <span class="n">pfs</span><span class="p">[</span><span class="n">minind</span><span class="p">]</span>
            <span class="n">bestX</span> <span class="o">=</span> <span class="n">Xs</span><span class="p">[</span><span class="n">minind</span><span class="p">]</span>
            <span class="n">startVal</span><span class="p">,</span> <span class="n">stopVal</span> <span class="o">=</span> <span class="n">Xs</span><span class="p">[</span><span class="n">minind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Xs</span><span class="p">[</span><span class="n">minind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">loops</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">bestX</span><span class="p">,</span> <span class="n">bestPf</span>

    <span class="c1">########################### Visualization Methods</span>

<div class="viewcode-block" id="SubSpace.plotThresholds"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.plotThresholds">[docs]</a>    <span class="k">def</span> <span class="nf">plotThresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conDatNum</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-.</span><span class="mi">01</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to sample the continuous data and plot the thresholds </span>
<span class="sd">        calculated with the SVD call with a histogram of detex&#39;s best </span>
<span class="sd">        estimate of the null space (see getFAS for more details)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------</span>
<span class="sd">        conDatNum : int</span>
<span class="sd">            The number of continuous data chunks to use in the sampling,</span>
<span class="sd">            duration of chunks defined in data fetcher</span>
<span class="sd">        xlim : list (number, number)</span>
<span class="sd">            The x limits on the plot (often it is useful to zoom in around 0)</span>
<span class="sd">            </span>
<span class="sd">        **kwargs are passed to the getFAS call</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">getFAS</span><span class="p">(</span><span class="n">conDatNum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">beta_a</span><span class="p">,</span> <span class="n">beta_b</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;betadist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;hist&#39;</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Station </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">))</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">beta_a</span><span class="p">,</span> <span class="n">beta_b</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;hist&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">beta</span><span class="p">)),</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> station </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;hist&#39;</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;hist&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">beta</span><span class="p">)),</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Detection Statistic&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="SubSpace.plotFracEnergy"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.plotFracEnergy">[docs]</a>    <span class="k">def</span> <span class="nf">plotFracEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to plot the fractional energy captured of by the subspace for</span>
<span class="sd">        various dimensions of rep. Each event is plotted as a grey dotted </span>
<span class="sd">        line, the average as a red solid line, and the chosen degree of rep.</span>
<span class="sd">        is plotted as a solid green vertical line.</span>
<span class="sd">        Similar to Harris 2006 Fig 8</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mf">1.85</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">FracEnergy</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;fractional energy not defiend, call SVD&#39;</span>
                    <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">FracEnergy</span><span class="p">[</span><span class="n">event</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.6&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">FracEnergy</span><span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">NumBasis</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Station </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=.</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="s1">&#39;Dimension of Representation&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Fraction of Energy Captured&#39;</span><span class="p">,</span>
                   <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="SubSpace.plotAlignedEvents"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.plotAlignedEvents">[docs]</a>    <span class="k">def</span> <span class="nf">plotAlignedEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># plot aligned subspaces in SubSpaces object</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Plots the aligned events for each station in each cluster. </span>
<span class="sd">        Will trim waveforms if trim times (by pickTimes or attachPickTimes)</span>
<span class="sd">        are defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">)])</span>
                <span class="c1"># f.set_figheight(1.85 * len(row.Events))</span>
                <span class="c1"># plt.subplot(len(self.subspaces[station]), 1, ind + 1)</span>
                <span class="n">events</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Events</span>
                <span class="n">stKeys</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>  <span class="c1"># sample trim keys</span>
                <span class="k">for</span> <span class="n">evenum</span><span class="p">,</span> <span class="n">eve</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
                    <span class="c1"># plt.subplot(len(self.subspaces[station]), 1, evenum + 1)</span>
                    <span class="n">aliTD</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">AlignedTD</span><span class="p">[</span><span class="n">eve</span><span class="p">]</span>  <span class="c1"># aligned wf for event eve</span>
                    <span class="k">if</span> <span class="s1">&#39;Starttime&#39;</span> <span class="ow">in</span> <span class="n">stKeys</span> <span class="ow">and</span> <span class="s1">&#39;Endtime&#39;</span> <span class="ow">in</span> <span class="n">stKeys</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Starttime&#39;</span><span class="p">]</span>
                        <span class="n">stop</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Endtime&#39;</span><span class="p">]</span>
                        <span class="n">aliwf</span> <span class="o">=</span> <span class="n">aliTD</span><span class="p">[</span><span class="n">start</span><span class="p">:</span> <span class="n">stop</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">aliwf</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">AlignedTD</span><span class="p">[</span><span class="n">eve</span><span class="p">]</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">aliwf</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">aliwf</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">evenum</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aliwf</span><span class="p">)])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">evenum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Station </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%d</span><span class="s1"> events&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="SubSpace.plotBasisVectors"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.plotBasisVectors">[docs]</a>    <span class="k">def</span> <span class="nf">plotBasisVectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onlyused</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the basis vectors selected after performing the SVD</span>
<span class="sd">        If SVD has not been called will throw error</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        onlyUsed : bool</span>
<span class="sd">            If true only the selected basis vectors will be plotted. See</span>
<span class="sd">            SVD for how detex selects basis vectors.</span>
<span class="sd">            If false all will be plotted (used in blue, unused in red)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SVDdefined</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;SVD not performed, call SVD before plotting basis vectors&#39;</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subnum</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">):</span>
            <span class="n">subsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">subsp</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">num_wfs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">UsedSVDKeys</span><span class="p">)</span> <span class="k">if</span> <span class="n">onlyused</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">SVD</span><span class="p">)</span>
                <span class="n">keyz</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SVD</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">keyz</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">keyz</span> <span class="o">=</span> <span class="n">keyz</span><span class="p">[:</span><span class="n">num_wfs</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span> <span class="o">*</span> <span class="n">num_wfs</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">keynum</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keyz</span><span class="p">):</span>
                    <span class="n">wf</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SVD</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">SVD</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">keynum</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">keynum</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">UsedSVDKeys</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;.5&#39;</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">keynum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> station </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">))</span></div>

<div class="viewcode-block" id="SubSpace.plotOffsetTimes"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.plotOffsetTimes">[docs]</a>    <span class="k">def</span> <span class="nf">plotOffsetTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to loop through each station/subspace pair and make </span>
<span class="sd">        histograms of offset times</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;subspaces must be trimmed before plotting offsets&#39;</span>
                    <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Events</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">numEvs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">)</span>
                <span class="n">ranmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numEvs</span><span class="p">)</span>
                <span class="n">ranmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numEvs</span><span class="p">)</span>
                <span class="n">orsamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numEvs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">evenum</span><span class="p">,</span> <span class="n">eve</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">):</span>
                    <span class="n">tem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">temkey</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">temkey</span><span class="o">.</span><span class="n">NAME</span> <span class="o">==</span> <span class="n">eve</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">condat</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">AlignedTD</span><span class="p">[</span>
                                 <span class="n">eve</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">AlignedTD</span><span class="p">[</span><span class="n">eve</span><span class="p">]))</span> <span class="o">+</span> <span class="n">evenum</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">Nc</span><span class="p">,</span> <span class="n">Sr</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">eve</span><span class="p">][</span><span class="s1">&#39;Nc&#39;</span><span class="p">],</span> <span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span>
                        <span class="n">eve</span><span class="p">][</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span>
                    <span class="n">starTime</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">eve</span><span class="p">][</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span>
                    <span class="n">ortime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">tem</span><span class="o">.</span><span class="n">TIME</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span>
                    <span class="n">orsamps</span><span class="p">[</span><span class="n">evenum</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span>
                                          <span class="s1">&#39;Starttime&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">starTime</span> <span class="o">-</span> <span class="n">ortime</span><span class="p">)</span> <span class="o">*</span> <span class="n">Nc</span> <span class="o">*</span> <span class="n">Sr</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">condat</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Starttime&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">orsamps</span><span class="p">[</span><span class="n">evenum</span><span class="p">],</span> <span class="n">evenum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;r*&#39;</span><span class="p">)</span>
                    <span class="n">ran</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Endtime&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">orsamps</span><span class="p">[</span><span class="n">evenum</span><span class="p">]</span>
                    <span class="n">ranmin</span><span class="p">[</span><span class="n">evenum</span><span class="p">]</span> <span class="o">=</span> <span class="n">orsamps</span><span class="p">[</span><span class="n">evenum</span><span class="p">]</span> <span class="o">-</span> <span class="n">ran</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span>
                    <span class="n">ranmax</span><span class="p">[</span><span class="n">evenum</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="s1">&#39;Endtime&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ran</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ranmin</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ranmax</span><span class="p">)))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">orsamps</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">orsamps</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">2</span></div>

    <span class="c1">############################# Pick Times functions </span>
<div class="viewcode-block" id="SubSpace.pickTimes"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.pickTimes">[docs]</a>    <span class="k">def</span> <span class="nf">pickTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">traceLimit</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">repick</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">subspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">singles</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls a modified version of obspyck (https://github.com/megies/obspyck)</span>
<span class="sd">        , a GUI for picking phases, so user can manually select start times </span>
<span class="sd">        (trim) of unclustered and clustered events.</span>
<span class="sd">        Triming down each waveform group to only include event phases, </span>
<span class="sd">        and not pre and post event noise, will significantly decrease the </span>
<span class="sd">        runtime for the subspace detection (called with detex method). </span>
<span class="sd">        Trimming is required for singletons as any singletons without trim</span>
<span class="sd">        times will not be used as detectors).</span>
<span class="sd">        Parameters</span>
<span class="sd">        --------------</span>
<span class="sd">        duration : real number</span>
<span class="sd">            the time after the first pick (in seconds) to trim waveforms.</span>
<span class="sd">            The fact that the streams are multiplexed is taken into account.</span>
<span class="sd">            If None is passed then the last pick will be used as the end time</span>
<span class="sd">            for truncating waveforms.</span>
<span class="sd">        traceLimit : int</span>
<span class="sd">            Limits the number of traces that will show up to be manually </span>
<span class="sd">            picked to traceLimit events. Avoids bogging down and/or killing </span>
<span class="sd">            the GUI with too many events.</span>
<span class="sd">        repick : boolean</span>
<span class="sd">            If true repick times that already have sample trim times, else</span>
<span class="sd">            only pick those that do not. </span>
<span class="sd">        subspace : boolean</span>
<span class="sd">            If true pick subspaces</span>
<span class="sd">        singles : boolean</span>
<span class="sd">            If true pick singletons</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qApp</span> <span class="o">=</span> <span class="n">PyQt4</span><span class="o">.</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subspace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pickTimes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">traceLimit</span><span class="p">,</span>
                            <span class="n">qApp</span><span class="p">,</span> <span class="n">repick</span><span class="o">=</span><span class="n">repick</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">singles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pickTimes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">traceLimit</span><span class="p">,</span> <span class="n">qApp</span><span class="p">,</span>
                            <span class="n">issubspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repick</span><span class="o">=</span><span class="n">repick</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_pickTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trdfDict</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">traceLimit</span><span class="p">,</span> <span class="n">qApp</span><span class="p">,</span>
                   <span class="n">issubspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">repick</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to initate GUI for picking, called by pickTimes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">trdfDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">trdfDict</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span> <span class="ow">or</span> <span class="n">repick</span><span class="p">:</span>  <span class="c1"># if not picked or repick</span>
                    <span class="c1"># Make a modified obspy stream to pass to streamPick</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeOpStream</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">traceLimit</span><span class="p">)</span>
                    <span class="n">Pks</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># This is needed or it crashes OS X</span>
                    <span class="n">Pks</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">streamPick</span><span class="o">.</span><span class="n">streamPick</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="n">qApp</span><span class="p">)</span>
                    <span class="n">d1</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Pks</span><span class="o">.</span><span class="n">_picks</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">b</span><span class="p">:</span>  <span class="c1"># if any picks made</span>
                            <span class="n">d1</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">phase_hint</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">timestamp</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if any picks made</span>
                        <span class="c1"># get sample rate and number of chans</span>
                        <span class="n">sr</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span>
                        <span class="n">Nc</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Nc&#39;</span><span class="p">]</span>
                        <span class="c1"># get sample divisible by NC to keep traces aligned</span>
                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>  <span class="c1"># first picked phase</span>
                        <span class="n">d1</span><span class="p">[</span><span class="s1">&#39;Starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span> <span class="o">-</span> <span class="n">fp</span> <span class="o">%</span> <span class="n">Nc</span>
                        <span class="c1"># if duration paramenter is defined (it is usually</span>
                        <span class="c1"># better to leave it defined)</span>
                        <span class="n">stime</span> <span class="o">=</span> <span class="n">d1</span><span class="p">[</span><span class="s1">&#39;Starttime&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">duration</span><span class="p">:</span>

                            <span class="n">etime</span> <span class="o">=</span> <span class="n">stime</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">sr</span> <span class="o">*</span> <span class="n">Nc</span><span class="p">)</span>
                            <span class="n">d1</span><span class="p">[</span><span class="s1">&#39;Endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etime</span>
                            <span class="n">d1</span><span class="p">[</span><span class="s1">&#39;DurationSeconds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">etime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                            <span class="n">d1</span><span class="p">[</span><span class="s1">&#39;Endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etime</span>
                            <span class="n">dursecs</span> <span class="o">=</span> <span class="p">(</span><span class="n">etime</span> <span class="o">-</span> <span class="n">stime</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sr</span> <span class="o">*</span> <span class="n">Nc</span><span class="p">)</span>
                            <span class="n">d1</span><span class="p">[</span><span class="s1">&#39;DurationSeconds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dursecs</span>
                        <span class="n">trdfDict</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">d1</span>
                        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">:</span>  <span class="c1"># update starttimes</span>
                            <span class="n">sspa</span> <span class="o">=</span> <span class="n">trdfDict</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span>
                            <span class="n">stimeOld</span> <span class="o">=</span> <span class="n">sspa</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">event</span><span class="p">][</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span>
                            <span class="c1"># get updated start time</span>
                            <span class="n">stN</span> <span class="o">=</span> <span class="n">stimeOld</span> <span class="o">+</span> <span class="n">d1</span><span class="p">[</span><span class="s1">&#39;Starttime&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">Nc</span> <span class="o">*</span> <span class="n">sr</span><span class="p">)</span>
                            <span class="n">ot</span> <span class="o">=</span> <span class="n">trdfDict</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">event</span><span class="p">][</span><span class="s1">&#39;origintime&#39;</span><span class="p">]</span>
                            <span class="n">offset</span> <span class="o">=</span> <span class="n">stN</span> <span class="o">-</span> <span class="n">ot</span>
                            <span class="n">trdfDict</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">event</span><span class="p">][</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stN</span>
                            <span class="n">trdfDict</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">event</span><span class="p">][</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">Pks</span><span class="o">.</span><span class="n">KeepGoing</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;aborting picking, progress saved&#39;</span>
                        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updateOffsets</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_makeOpStream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">traceLimit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make an obspy stream of the multiplexed data stored in main detex </span>
<span class="sd">        DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;AlignedTD&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>  <span class="c1"># if this is a subspace</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">traceLimit</span><span class="p">:</span>
                    <span class="n">tr</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">AlignedTD</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Name</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Station</span>
                    <span class="n">st</span> <span class="o">+=</span> <span class="n">tr</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">st</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if this is a single event</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">:</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">MPtd</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Station</span>
                <span class="n">st</span> <span class="o">+=</span> <span class="n">tr</span>
            <span class="k">return</span> <span class="n">st</span>

    <span class="k">def</span> <span class="nf">_updateOffsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate offset (predicted origin times), throw out extreme </span>
<span class="sd">        outliers using median and median scaling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">Offsets</span><span class="p">[</span>
                    <span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getOffsets</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">offsets</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">Offsets</span><span class="p">[</span>
                    <span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getOffsets</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">offsets</span><span class="p">))</span>

<div class="viewcode-block" id="SubSpace.attachPickTimes"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.attachPickTimes">[docs]</a>    <span class="k">def</span> <span class="nf">attachPickTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pksFile</span><span class="o">=</span><span class="s1">&#39;PhasePicks.csv&#39;</span><span class="p">,</span>
                        <span class="n">function</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">defaultDuration</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rather than picking times manually attach a file (either csv or pkl </span>
<span class="sd">        of pandas dataframe) with pick times. Pick time file must have the </span>
<span class="sd">        following fields:  TimeStamp, Station, Event, Phase. </span>
<span class="sd">        This file can be created by detex.util.pickPhases. If trims are </span>
<span class="sd">        already defined attachPickTimes will not override.</span>
<span class="sd">        ----------</span>
<span class="sd">        pksFile : str</span>
<span class="sd">            Path to the input file (either csv or pickle)</span>
<span class="sd">        function : str  (&#39;Average&#39;,&#39;Max&#39;, or &#39;Min&#39;)</span>
<span class="sd">            Describes how to handle selecting a common pick time for </span>
<span class="sd">            subspace groups (each event in a subspace cannot be treated </span>
<span class="sd">            independently as the entire group is aligned to maximize </span>
<span class="sd">            similarity). Does not apply for singles.</span>
<span class="sd">            mean - Trims the group to the sample corresponding to the </span>
<span class="sd">                average of the first arriving phase</span>
<span class="sd">            median - Trims the group to the sample corresponding to the </span>
<span class="sd">                median of the first arriving phase</span>
<span class="sd">            max - trim to max value of start times for group</span>
<span class="sd">            min - trim to min value of end times for group</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        defaultDuration : int or None</span>
<span class="sd">            if Int, the default duration (in seconds) to trim the signal to </span>
<span class="sd">            starting from the first arrival in pksFile for each event or </span>
<span class="sd">            subspace group. If None, then durations are defined by first </span>
<span class="sd">            arriving phase (start) and last arriving phase (stop) for each</span>
<span class="sd">            event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># read pksFile</span>
            <span class="n">pks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pksFile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">pksFile</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not exist, or it is not a pkl or csv file&#39;</span>
                       <span class="o">%</span> <span class="n">pksFile</span><span class="p">)</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

        <span class="c1"># get appropriate function according to ssmod</span>
        <span class="k">if</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span>
        <span class="k">elif</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span>
        <span class="k">elif</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span>
        <span class="k">elif</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;function </span><span class="si">%s</span><span class="s1"> not supported, options are: mean, median, min,&#39;</span>
                   <span class="s1">&#39; max&#39;</span> <span class="o">%</span> <span class="n">function</span><span class="p">)</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="c1"># loop through each station in cluster, get singles and subspaces</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
            <span class="n">sta</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">station</span>  <span class="c1"># current station</span>
            <span class="c1"># Attach singles</span>
            <span class="k">if</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># skip if sampletrims already defined</span>
                    <span class="c1"># get phases that apply to current event and station</span>
                    <span class="n">con1</span> <span class="o">=</span> <span class="n">pks</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">)</span>
                    <span class="n">con2</span> <span class="o">=</span> <span class="n">pks</span><span class="o">.</span><span class="n">Station</span> <span class="o">==</span> <span class="n">sta</span>
                    <span class="n">pk</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[(</span><span class="n">con1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">con2</span><span class="p">)]</span>
                    <span class="n">eves</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getStats</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">trims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getSampTrim</span><span class="p">(</span><span class="n">eves</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Sr</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span>
                                                  <span class="n">defaultDuration</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
                                                  <span class="n">ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">],</span> <span class="n">row</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trims</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">trims</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_updateOffsets</span><span class="p">()</span>
            <span class="c1"># Attach Subspaces</span>
            <span class="k">if</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">SampleTrims</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># skip if sampletrims already defined</span>
                    <span class="c1"># phases that apply to current event and station</span>
                    <span class="n">con1</span> <span class="o">=</span> <span class="n">pks</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Events</span><span class="p">)</span>
                    <span class="n">con2</span> <span class="o">=</span> <span class="n">pks</span><span class="o">.</span><span class="n">Station</span> <span class="o">==</span> <span class="n">sta</span>
                    <span class="n">pk</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[(</span><span class="n">con1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">con2</span><span class="p">)]</span>
                    <span class="n">eves</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getStats</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                        <span class="n">trims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getSampTrim</span><span class="p">(</span><span class="n">eves</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Sr</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span>
                                                  <span class="n">defaultDuration</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
                                                  <span class="n">ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">],</span> <span class="n">row</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trims</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">SampleTrims</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">trims</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_updateOffsets</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_getSampTrim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eves</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Sr</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">defaultDuration</span><span class="p">,</span>
                     <span class="n">fun</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">DF</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine sample trims for each single or subspace</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># stdict={}#intialize sample trim dict</span>
        <span class="n">startsamps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stopsamps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">secduration</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">eves</span><span class="p">:</span>  <span class="c1"># loop through each event</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">pk</span><span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">Event</span> <span class="o">==</span> <span class="n">ev</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if event is not recorded skip</span>
                <span class="k">continue</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">TimeStamp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">startsampsEve</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">starttimes</span><span class="p">[</span><span class="n">ev</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nc</span> <span class="o">*</span> <span class="n">Sr</span><span class="p">)</span>
            <span class="c1"># see if any of the samples would be trimmed too much</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># assume is single</span>
                <span class="n">len_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">MPtd</span><span class="p">[</span><span class="n">ev</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">startsampsEve</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># this is really a subspace</span>
                <span class="n">len_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">AlignedTD</span><span class="p">[</span><span class="n">ev</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">startsampsEve</span>
            <span class="k">if</span> <span class="n">len_test</span><span class="p">:</span>
                <span class="n">utc_start</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;Start samples for </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1"> exceeds avaliable data,&#39;</span>
                        <span class="s1">&#39;check waveform quality and ensure phase pick is for &#39;</span>
                        <span class="s1">&#39;the correct event. The origin time is </span><span class="si">%s</span><span class="s1"> and the &#39;</span>
                        <span class="s1">&#39;pick time is </span><span class="si">%s</span><span class="s1">, Skipping attaching pick. &#39;</span>
                        <span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">utc_start</span><span class="p">)))</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># make sure starting time is not less than 0 else set to zero</span>
            <span class="k">if</span> <span class="n">startsampsEve</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">startsampsEve</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">starttimes</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Start time in phase file &lt; 0 for event </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ev</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">defaultDuration</span><span class="p">:</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">defaultDuration</span>
                <span class="n">secduration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">defaultDuration</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">TimeStamp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">secduration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="n">start</span>  <span class="c1"># Make sure stop is greater than start</span>
            <span class="k">assert</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="n">starttimes</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
            <span class="n">endsampsEve</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">starttimes</span><span class="p">[</span><span class="n">ev</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nc</span> <span class="o">*</span> <span class="n">Sr</span><span class="p">)</span>
            <span class="n">startsamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">startsampsEve</span><span class="p">)</span>
            <span class="n">stopsamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">endsampsEve</span><span class="p">)</span>
            <span class="c1"># update stats attached to each event to reflect new start time</span>
            <span class="n">otime</span> <span class="o">=</span> <span class="n">DF</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="n">ev</span><span class="p">][</span><span class="s1">&#39;origintime&#39;</span><span class="p">]</span>  <span class="c1"># origin time</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="n">ev</span><span class="p">][</span><span class="s1">&#39;Starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>
            <span class="n">DF</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="n">ev</span><span class="p">][</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">otime</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">startsamps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sSamps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="n">startsamps</span><span class="p">))</span>
            <span class="n">rSSamps</span> <span class="o">=</span> <span class="n">sSamps</span> <span class="o">-</span> <span class="n">sSamps</span> <span class="o">%</span> <span class="n">Nc</span>
            <span class="n">eSamps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="n">stopsamps</span><span class="p">))</span>
            <span class="n">rESamps</span> <span class="o">=</span> <span class="n">eSamps</span> <span class="o">-</span> <span class="n">eSamps</span> <span class="o">%</span> <span class="n">Nc</span>
            <span class="n">dursec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="n">secduration</span><span class="p">))</span>
            <span class="n">outdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Starttime&#39;</span><span class="p">:</span> <span class="n">rSSamps</span><span class="p">,</span> <span class="s1">&#39;Endtime&#39;</span><span class="p">:</span> <span class="n">rESamps</span><span class="p">,</span>
                       <span class="s1">&#39;DurationSeconds&#39;</span><span class="p">:</span> <span class="n">dursec</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">outdict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_getStats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the sampling rate, starttime, and number of channels for </span>
<span class="sd">        each event group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eves</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Events</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eves</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Events </span><span class="si">%s</span><span class="s1"> on Station </span><span class="si">%s</span><span class="s1"> have different sampling rates or &#39;</span>
                   <span class="s1">&#39;no sampling rates&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">events</span><span class="p">))</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">Nc</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;Nc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eves</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">Nc</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;Events </span><span class="si">%s</span><span class="s1"> on Station </span><span class="si">%s</span><span class="s1"> do not have the same channels or&#39;</span>
                    <span class="s1">&#39; have no channels&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">events</span><span class="p">))</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">starttimes</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">Stats</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eves</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">eves</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">Nc</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sr</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_getOffsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mf">25.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get offsets, reject outliers bassed on median values (accounts </span>
<span class="sd">        for possible mismatch in events and origin times)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">offsets</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">offsets</span><span class="p">))</span>
        <span class="n">mdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">mdev</span> <span class="k">if</span> <span class="n">mdev</span> <span class="k">else</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">offs</span> <span class="o">=</span> <span class="n">offsets</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offs</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">offs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">offs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">offs</span><span class="p">)]</span>

<div class="viewcode-block" id="SubSpace.getFAS"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.getFAS">[docs]</a>    <span class="k">def</span> <span class="nf">getFAS</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">conDatNum</span><span class="p">,</span>
            <span class="n">LTATime</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">STATime</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">staltalimit</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span>
            <span class="n">useSubSpaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">useSingles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">numBins</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span>
            <span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to initialize a FAS (false alarm statistic) instance, used</span>
<span class="sd">        primarily for sampling and characterizing the null space of the </span>
<span class="sd">        subspaces and singletons. Random samples of the continuous data are</span>
<span class="sd">        loaded, examined for high amplitude signals with a basic STA/LTA </span>
<span class="sd">        method, and any traces with STA/LTA ratios higher than the </span>
<span class="sd">        staltalimit parameter are rejected. The continuous DataFetcher</span>
<span class="sd">        already attached to the SubSpace instance will be used to get</span>
<span class="sd">        the continuous data. </span>
<span class="sd">        Parameters</span>
<span class="sd">        -------------        </span>
<span class="sd">        ConDatNum : int</span>
<span class="sd">            The number of continuous data files (by default in hour chunks)</span>
<span class="sd">            to use.</span>
<span class="sd">        LTATime : float </span>
<span class="sd">            The long term average time window in seconds used for </span>
<span class="sd">            checking continuous data</span>
<span class="sd">        STATime : float</span>
<span class="sd">            The short term average time window in seconds for checking</span>
<span class="sd">            continuous data</span>
<span class="sd">        staltalimit : int or float</span>
<span class="sd">            The value at which continuous data gets rejected as too noisey</span>
<span class="sd">            (IE transient signals are present)</span>
<span class="sd">        useSubSpaces : bool</span>
<span class="sd">            If True calculate FAS for subspaces</span>
<span class="sd">        useSingles : bool</span>
<span class="sd">            If True calculate FAS for singles</span>
<span class="sd">        numBins : int</span>
<span class="sd">            Number of bins for binning distributions (so distribution can be </span>
<span class="sd">            loaded and plotted later)</span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        ---------</span>
<span class="sd">        The results are stored in a DataFrame for each subspace/singleton</span>
<span class="sd">        under the &quot;FAS&quot; column of the main DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">useSubSpaces</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updateOffsets</span><span class="p">()</span>  <span class="c1"># make sure offset times are up to date</span>
            <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># check if FAS already calculated, only recalc if recalc</span>
                <span class="n">fas1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">][</span><span class="s1">&#39;FAS&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fas1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recalc</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;FAS for station </span><span class="si">%s</span><span class="s1"> already calculated, to &#39;</span>
                           <span class="s1">&#39;recalculate pass True to the parameter recalc&#39;</span> <span class="o">%</span>
                           <span class="n">sta</span><span class="p">)</span>
                    <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">][</span><span class="s1">&#39;FAS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">fas</span><span class="o">.</span><span class="n">_initFAS</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">],</span>
                        <span class="n">conDatNum</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cfetcher</span><span class="p">,</span>
                        <span class="n">LTATime</span><span class="o">=</span><span class="n">LTATime</span><span class="p">,</span>
                        <span class="n">STATime</span><span class="o">=</span><span class="n">STATime</span><span class="p">,</span>
                        <span class="n">staltalimit</span><span class="o">=</span><span class="n">staltalimit</span><span class="p">,</span>
                        <span class="n">numBins</span><span class="o">=</span><span class="n">numBins</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">useSingles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">])):</span>
                    <span class="n">fas1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">][</span><span class="s1">&#39;FAS&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fas1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recalc</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;FAS for singleton </span><span class="si">%d</span><span class="s1"> already calculated on &#39;</span>
                                <span class="s1">&#39;station </span><span class="si">%s</span><span class="s1">, to recalculate pass True to the &#39;</span>
                                <span class="s1">&#39;parameter recalc&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sta</span><span class="p">))</span>
                        <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># skip any events that have not been trimmed</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">][</span><span class="s1">&#39;SampleTrims&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">][</span><span class="s1">&#39;FAS&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">detex</span><span class="o">.</span><span class="n">fas</span><span class="o">.</span><span class="n">_initFAS</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">][</span><span class="n">a</span><span class="p">:</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">conDatNum</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cfetcher</span><span class="p">,</span>
                            <span class="n">LTATime</span><span class="o">=</span><span class="n">LTATime</span><span class="p">,</span>
                            <span class="n">STATime</span><span class="o">=</span><span class="n">STATime</span><span class="p">,</span>
                            <span class="n">staltalimit</span><span class="o">=</span><span class="n">staltalimit</span><span class="p">,</span>
                            <span class="n">numBins</span><span class="o">=</span><span class="n">numBins</span><span class="p">,</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                            <span class="n">issubspace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SubSpace.detex"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.detex">[docs]</a>    <span class="k">def</span> <span class="nf">detex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">utcStart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">utcEnd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">subspaceDB</span><span class="o">=</span><span class="s1">&#39;SubSpace.db&#39;</span><span class="p">,</span>
              <span class="n">trigCon</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
              <span class="n">triggerLTATime</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
              <span class="n">triggerSTATime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
              <span class="n">multiprocess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">delOldCorrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">calcHist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">useSubSpaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">useSingles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">estimateMags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">classifyEvents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">eventCorFile</span><span class="o">=</span><span class="s1">&#39;EventCors&#39;</span><span class="p">,</span>
              <span class="n">utcSaves</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">fillZeros</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to run subspace detection over continuous data and store </span>
<span class="sd">        results in SQL database subspaceDB</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        utcStart : str or num</span>
<span class="sd">            An obspy.core.UTCDateTime readable object defining the start time</span>
<span class="sd">            of the correlations if not all avaliable data are to be used</span>
<span class="sd">        utcEnd : str num</span>
<span class="sd">            An obspy.core.UTCDateTime readable object defining the end time </span>
<span class="sd">            of the correlations</span>
<span class="sd">        subspaceDB : str</span>
<span class="sd">            Path to the SQLite database to store detections in. If it already </span>
<span class="sd">            exists delOldCorrs parameters governs if it will be deleted before</span>
<span class="sd">            running new detections, or appended to. </span>
<span class="sd">        trigCon is the condition for which detections should trigger. </span>
<span class="sd">            Once the condition is set the variable minCoef is used:</span>
<span class="sd">                0 is based on the detection statistic threshold</span>
<span class="sd">                1 is based on the STA/LTA of the detection statistic threshold</span>
<span class="sd">                (Only 0 is currently supported)</span>
<span class="sd">        triggerLTATime : number</span>
<span class="sd">            The long term average for the STA/LTA calculations in seconds.</span>
<span class="sd">        triggerSTATime : number</span>
<span class="sd">            The short term average for the STA/LTA calculations in seconds. </span>
<span class="sd">            If ==0 then one sample is used.</span>
<span class="sd">        multiprocess : bool</span>
<span class="sd">            Determine if each station should be forked into its own process </span>
<span class="sd">            for potential speed ups. Currently not implemented. </span>
<span class="sd">        delOldCorrs : bool</span>
<span class="sd">            Determines if subspaceDB should be deleted before performing </span>
<span class="sd">            detections. If False old database is appended to. </span>
<span class="sd">        calcHist : boolean</span>
<span class="sd">            If True calculates the histagram for every point of the detection </span>
<span class="sd">            statistic vectors (all hours, stations and subspaces) by keeping a</span>
<span class="sd">            a cumulative bin count. Only slows the detections down slightly </span>
<span class="sd">            and can be useful for threshold sanity checks. The histograms are</span>
<span class="sd">            then returned to the main DataFrame in the SubSpace instance</span>
<span class="sd">            as the column histSubSpaces, and saved in the subspaceDB under the</span>
<span class="sd">            ss_hist and sg_hists tables for subspacs and singletons. </span>
<span class="sd">        useSubspace : bool</span>
<span class="sd">            If True the subspaces will be used as detectors to scan </span>
<span class="sd">            continuous data</span>
<span class="sd">        useSingles : bool</span>
<span class="sd">            If True the singles (events that did not cluster) will be used as </span>
<span class="sd">            detectors to scan continuous data</span>
<span class="sd">        estimateMags : bool</span>
<span class="sd">            If True, magnitudes will be estimated for each detection by using</span>
<span class="sd">            two methods. The first is using standard deviation ratios, and the </span>
<span class="sd">            second uses projected energy ratios (see chambers et al. 2015 for</span>
<span class="sd">            details).</span>
<span class="sd">        classifyEvents : None, str, or DataFrame</span>
<span class="sd">            If None subspace detectors will be run over continuous data.</span>
<span class="sd">            Else, detex will be run over event waveforms in order to classify</span>
<span class="sd">            events into groups bassed on which subspace they are most similar</span>
<span class="sd">            to. In the latter case the classifyEvents argument must be a </span>
<span class="sd">            str (path to template key like csv) or DataFrame (loaded template</span>
<span class="sd">            key file). The same event DataFetcher attached to the cluster</span>
<span class="sd">            object will be used to get the data. This feature is Experimental. </span>
<span class="sd">        eventCorFile : str</span>
<span class="sd">            A path to a new pickled DataFrame created when the eventDir option</span>
<span class="sd">            is used. Records the highest detection statistic in the file </span>
<span class="sd">            for each event, station, and subspace. Useful when trying to</span>
<span class="sd">            characterize events.</span>
<span class="sd">        utcSaves : None or list of obspy DateTime readable objects</span>
<span class="sd">            Either none (not used) or an iterrable of objects readable by </span>
<span class="sd">            obspy.UTCDateTime. When the detections are run if the continous </span>
<span class="sd">            data cover a time indicated in UTCSaves then the continuous data </span>
<span class="sd">            and detection statistic vectors,are saved to a pickled dataframe</span>
<span class="sd">            of the name &quot;UTCsaves.pkl&quot;. This can be useful for debugging, or </span>
<span class="sd">            extracting the DS vector for a time of interest. </span>
<span class="sd">        fillZeros : bool</span>
<span class="sd">            If true fill the gaps in continuous data with 0s. If True </span>
<span class="sd">            STA/LTA of detection statistic cannot be calculated in order to </span>
<span class="sd">            avoid dividing by 0.</span>
<span class="sd">        Notes</span>
<span class="sd">        ----------</span>
<span class="sd">        The same filter and decimation parameters that were used in the</span>
<span class="sd">        ClusterStream instance will be applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make sure no parameters that dont work yet are selected</span>
        <span class="k">if</span> <span class="n">multiprocess</span> <span class="ow">or</span> <span class="n">trigCon</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;multiprocessing and trigcon other than 0 not supported&#39;</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subspaceDB</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">delOldCorrs</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">subspaceDB</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Deleting old subspace database </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subspaceDB</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Not deleting old subspace database </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subspaceDB</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">useSubSpaces</span><span class="p">:</span>  <span class="c1"># run subspaces</span>
            <span class="n">TRDF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span>
            <span class="c1"># determine if subspaces are defined (ie SVD has been called)</span>
            <span class="n">stas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">sv</span> <span class="o">=</span> <span class="p">[</span><span class="nb">all</span><span class="p">(</span><span class="n">TRDF</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">SVDdefined</span><span class="p">)</span> <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">stas</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">sv</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;call SVD before running subspace detectors&#39;</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

            <span class="n">Det</span> <span class="o">=</span> <span class="n">_SSDetex</span><span class="p">(</span><span class="n">TRDF</span><span class="p">,</span> <span class="n">utcStart</span><span class="p">,</span> <span class="n">utcEnd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfetcher</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span>
                           <span class="n">subspaceDB</span><span class="p">,</span> <span class="n">trigCon</span><span class="p">,</span> <span class="n">triggerLTATime</span><span class="p">,</span> <span class="n">triggerSTATime</span><span class="p">,</span>
                           <span class="n">multiprocess</span><span class="p">,</span> <span class="n">calcHist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">estimateMags</span><span class="p">,</span>
                           <span class="n">classifyEvents</span><span class="p">,</span> <span class="n">eventCorFile</span><span class="p">,</span> <span class="n">utcSaves</span><span class="p">,</span> <span class="n">fillZeros</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">histSubSpaces</span> <span class="o">=</span> <span class="n">Det</span><span class="o">.</span><span class="n">hist</span>

        <span class="k">if</span> <span class="n">useSingles</span><span class="p">:</span>  <span class="c1"># run singletons</span>
            <span class="c1"># make sure thresholds are calcualted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setSinglesThresholds</span><span class="p">()</span>
            <span class="n">TRDF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span>
            <span class="n">Det</span> <span class="o">=</span> <span class="n">_SSDetex</span><span class="p">(</span><span class="n">TRDF</span><span class="p">,</span> <span class="n">utcStart</span><span class="p">,</span> <span class="n">utcEnd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfetcher</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span>
                           <span class="n">subspaceDB</span><span class="p">,</span> <span class="n">trigCon</span><span class="p">,</span> <span class="n">triggerLTATime</span><span class="p">,</span> <span class="n">triggerSTATime</span><span class="p">,</span>
                           <span class="n">multiprocess</span><span class="p">,</span> <span class="n">calcHist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">estimateMags</span><span class="p">,</span>
                           <span class="n">classifyEvents</span><span class="p">,</span> <span class="n">eventCorFile</span><span class="p">,</span> <span class="n">utcSaves</span><span class="p">,</span> <span class="n">fillZeros</span><span class="p">,</span>
                           <span class="n">issubspace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">histSingles</span> <span class="o">=</span> <span class="n">Det</span><span class="o">.</span><span class="n">hist</span>

        <span class="c1"># save addational info to sql database</span>
        <span class="k">if</span> <span class="n">useSubSpaces</span> <span class="ow">or</span> <span class="n">useSingles</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FREQMIN&#39;</span><span class="p">,</span> <span class="s1">&#39;FREQMAX&#39;</span><span class="p">,</span> <span class="s1">&#39;CORNERS&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEROPHASE&#39;</span><span class="p">]</span>
            <span class="n">dffil</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">filt</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">saveSQLite</span><span class="p">(</span><span class="n">dffil</span><span class="p">,</span> <span class="n">subspaceDB</span><span class="p">,</span> <span class="s1">&#39;filt_params&#39;</span><span class="p">)</span>

            <span class="c1"># get general info on each singleton/subspace and save</span>
            <span class="n">ssinfo</span><span class="p">,</span> <span class="n">sginfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getInfoDF</span><span class="p">()</span>
            <span class="n">sshists</span><span class="p">,</span> <span class="n">sghists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getHistograms</span><span class="p">(</span><span class="n">useSubSpaces</span><span class="p">,</span> <span class="n">useSingles</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">useSubSpaces</span> <span class="ow">and</span> <span class="n">ssinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># save subspace info</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">saveSQLite</span><span class="p">(</span><span class="n">ssinfo</span><span class="p">,</span> <span class="n">subspaceDB</span><span class="p">,</span> <span class="s1">&#39;ss_info&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">useSingles</span> <span class="ow">and</span> <span class="n">sginfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># save singles info</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">saveSQLite</span><span class="p">(</span><span class="n">sginfo</span><span class="p">,</span> <span class="n">subspaceDB</span><span class="p">,</span> <span class="s1">&#39;sg_info&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">useSubSpaces</span> <span class="ow">and</span> <span class="n">sshists</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># save subspace histograms</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">saveSQLite</span><span class="p">(</span><span class="n">sshists</span><span class="p">,</span> <span class="n">subspaceDB</span><span class="p">,</span> <span class="s1">&#39;ss_hist&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">useSingles</span> <span class="ow">and</span> <span class="n">sghists</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># save singles histograms</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">saveSQLite</span><span class="p">(</span><span class="n">sghists</span><span class="p">,</span> <span class="n">subspaceDB</span><span class="p">,</span> <span class="s1">&#39;sg_hist&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_getInfoDF</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get dataframes that have info about each subspace and single</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sslist</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list in which to put DFs for each subspace/station pair</span>
        <span class="n">sglist</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list in which to put DFs for each single/station pair</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sta</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No subspaces on station </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sta</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  <span class="c1"># write ss info</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">Name</span>
                <span class="n">station</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">Station</span>
                <span class="n">events</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Events</span><span class="p">)</span>
                <span class="n">numbasis</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">NumBasis</span>
                <span class="n">thresh</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">Threshold</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">FAS</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">FAS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;betadist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ss</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="s1">&#39;betadist&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Sta&#39;</span><span class="p">,</span> <span class="s1">&#39;Events&#39;</span><span class="p">,</span> <span class="s1">&#39;Threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;NumBasisUsed&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;beta1&#39;</span><span class="p">,</span> <span class="s1">&#39;beta2&#39;</span><span class="p">]</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="p">[[</span><span class="n">name</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">numbasis</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">]]</span>
                <span class="n">sslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sta</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singStations</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No singletons on station </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sta</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  <span class="c1"># write singles info</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">Name</span>
                <span class="n">station</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">Station</span>
                <span class="n">events</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Events</span><span class="p">)</span>
                <span class="n">thresh</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">Threshold</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">FAS</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;betadist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ss</span><span class="o">.</span><span class="n">FAS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;betadist&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Sta&#39;</span><span class="p">,</span> <span class="s1">&#39;Events&#39;</span><span class="p">,</span> <span class="s1">&#39;Threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;beta1&#39;</span><span class="p">,</span> <span class="s1">&#39;beta2&#39;</span><span class="p">]</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="p">[[</span><span class="n">name</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">]]</span>
                <span class="n">sglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ssinfo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sslist</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ssinfo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sglist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sginfo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sglist</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sginfo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">ssinfo</span><span class="p">,</span> <span class="n">sginfo</span>

    <span class="k">def</span> <span class="nf">_getHistograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">useSubSpaces</span><span class="p">,</span> <span class="n">useSingles</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull out the histogram info for saving to database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Sta&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">useSubSpaces</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">histSubSpaces</span><span class="p">[</span><span class="s1">&#39;Bins&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;Bins&#39;</span><span class="p">,</span> <span class="s1">&#39;Bins&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="p">]]</span>
            <span class="n">sshists</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">histSubSpaces</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">skey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">histSubSpaces</span><span class="p">[</span><span class="n">sta</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">vl</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">histSubSpaces</span><span class="p">[</span><span class="n">sta</span><span class="p">][</span><span class="n">skey</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">dat</span> <span class="o">=</span> <span class="p">[[</span><span class="n">skey</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">vl</span><span class="p">]]</span>
                        <span class="n">sshists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>
            <span class="n">sshist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sshists</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sshist</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">useSingles</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">histSingles</span><span class="p">[</span><span class="s1">&#39;Bins&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;Bins&#39;</span><span class="p">,</span> <span class="s1">&#39;Bins&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="p">]]</span>
            <span class="n">sghists</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">histSingles</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">skey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">histSingles</span><span class="p">[</span><span class="n">sta</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">vl</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">histSingles</span><span class="p">[</span><span class="n">sta</span><span class="p">][</span><span class="n">skey</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">dat</span> <span class="o">=</span> <span class="p">[[</span><span class="n">skey</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">vl</span><span class="p">]]</span>
                        <span class="n">sghists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>
            <span class="n">sghist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sghists</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sghist</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">sshist</span><span class="p">,</span> <span class="n">sghist</span>

    <span class="c1">########################### Python Class Attributes</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>  <span class="c1"># make object indexable</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stakey2</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stakey1</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a station in this cluster object&#39;</span> <span class="o">%</span> <span class="n">key</span>
                <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> must either be a int or str of station name&#39;</span> <span class="o">%</span> <span class="n">key</span>
            <span class="n">detex</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">)</span>

    <span class="c1">############ MISC </span>
<div class="viewcode-block" id="SubSpace.write"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;subspace.pkl&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pickle the subspace class</span>
<span class="sd">        Parameters</span>
<span class="sd">        -------------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Path of the file to be created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="SubSpace.printOffsets"><a class="viewcode-back" href="../../detex.html#detex.subspace.SubSpace.printOffsets">[docs]</a>    <span class="k">def</span> <span class="nf">printOffsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to print out the offset min max and ranges for each </span>
<span class="sd">        station/subpace pair</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssStations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, min=</span><span class="si">%3f</span><span class="s1">, max=</span><span class="si">%3f</span><span class="s1">, range=</span><span class="si">%3f</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Station</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">Offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="o">.</span><span class="n">Offsets</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                       <span class="n">row</span><span class="o">.</span><span class="n">Offsets</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="o">.</span><span class="n">Offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">detex</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../detex.html">detex package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../detex.html">detex</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Derrick Chambers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>